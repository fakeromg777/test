<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 é‹¼ç´éŠæˆ² (å«æ¸¬è©¦åŠŸèƒ½)</title>

    <!-- âœ… Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; text-align: center; background: #222; color: white; padding-top: 20px;}
        .box { border: 1px solid #555; padding: 20px; margin: 15px auto; max-width: 500px; border-radius: 10px; background: #333; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; margin: 5px;}
        .btn-connect { background: #007bff; color: white; }
        .btn-start { background: #28a745; color: white; font-size: 24px; padding: 15px 40px; display: none;}
        .status-ok { color: #4cff00; font-weight: bold; }

        .test-panel { background: #444; padding: 10px; border-radius: 5px; margin-top: 10px; display:none; border: 1px dashed #777;}
        .test-btn { background: #666; color: white; font-size: 14px; padding: 8px 15px; }
        .test-btn:active { background: #888; }

        #gameArea { display: none; margin-top: 30px; }
        .timer { font-size: 40px; color: #00d2ff; font-family: monospace; }
        .note-display { font-size: 80px; color: yellow; font-weight: bold; margin: 20px 0; }
        .instruction { color: #ff9999; font-size: 18px; margin-bottom: 10px;}
        input[type=range] { width: 80%; cursor: pointer; }
        .debug-area { margin-top: 50px; border-top: 1px solid #555; padding-top: 20px; color: gray; font-size: 0.9em; }

        /* å ±è¡¨é å¯¬ä¸€é» */
        .box-wide { max-width: 900px; }
    </style>
</head>

<body>

<div id="loginBox">
  <input id="idInput" placeholder="è¼¸å…¥ç·¨è™Ÿ" />
  <input id="nameInput" placeholder="ç©å®¶å§“å" readonly />
  <button onclick="login()">ç™»å…¥</button>
  <p id="loginMsg"></p>
</div>

<div id="addBox" style="margin-top:20px;">
  <h3 style="color:#fff;">â• æ–°å¢äººå“¡</h3>
  <div style="display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap;">
    <input id="newId" placeholder="è‡ªå‹•ç·¨è™Ÿ" readonly>
    <input id="newName" placeholder="è¼¸å…¥å§“å">
    <button onclick="addPlayer()">å„²å­˜</button>
  </div>
  <p id="addMsg"></p>
</div>

<div id="app" style="display:none;">

  <h1>ğŸµ ESP32 é‹¼ç´æŒ‘æˆ° (æ¸¬è©¦ç‰ˆ)</h1>
  <h2>ğŸ‘¤ ç©å®¶ï¼š<span id="userName">---</span>
      <button type="button" onclick="logout()">ç™»å‡º</button>
  </h2>

  <!-- âœ… ä¸»é ï¼ˆéŠæˆ²é ï¼‰åŒ…èµ·ä¾†ï¼Œæ–¹ä¾¿åˆ‡æ›åˆ°å ±è¡¨é  -->
  <div id="mainPage">

    <div class="box">
      <h3>1. è£ç½®é€£ç·šèˆ‡æ¸¬è©¦</h3>
      <p>LEDæ¿: <span id="ledStatus">æœªé€£ç·š âŒ</span> <button class="btn-connect" onclick="connectLed()">é€£æ¥</button></p>
      <p>æŒ‰éˆ•æ¿: <span id="btnStatus">æœªé€£ç·š âŒ</span> <button class="btn-connect" onclick="connectBtn()">é€£æ¥</button></p>

      <div id="hardwareTest" class="test-panel">
        <h4>ğŸ”§ ç¡¬é«”æ¸¬è©¦å€</h4>
        <p>æ¸¬è©¦ç‡ˆè™Ÿ (é»æ“Šäº®ç‡ˆ):</p>
        <button class="test-btn" onclick="testLed(1)">1 (è—)</button>
        <button class="test-btn" onclick="testLed(2)">2 (ç´…)</button>
        <button class="test-btn" onclick="testLed(3)">3 (é»ƒ)</button>
        <button class="test-btn" onclick="testLed(4)">4 (ç¶ )</button>
        <button class="test-btn" onclick="testLed(5)">5 (ç™½)</button>
        <button class="test-btn" onclick="testLed(0)">é—œç‡ˆ</button>

        <p style="margin-top:15px; border-top:1px solid #666; padding-top:10px;">
          æ¸¬è©¦è²éŸ³èˆ‡æŒ‰éˆ•:<br>
          <label style="font-size:18px; color:#00d2ff;">
            <input type="checkbox" id="soundTestToggle" onchange="toggleSoundTest(this)">
            é–‹å•Ÿè²éŸ³æ¸¬è©¦ (è‡ªç”±ç™¼è²)
          </label>
        </p>

        <p>æœ€å¾ŒæŒ‰ä¸‹çš„æŒ‰éˆ•:
          <span id="lastPressed" style="font-size:24px; color:yellow; font-weight:bold;">-</span>
        </p>

        <div style="margin-top:10px;">
          ğŸ”Š éŸ³é‡: <span id="volVal">25</span>%
          <br>
          <input type="range" min="0" max="100" value="25" oninput="updateVolume(this.value)">
        </div>
      </div>
    </div>

    <div class="box" id="controlBox">
      <h3>2. é¸æ“‡é—œå¡ (éŠæˆ²é–‹å§‹)</h3>

      <select id="songSelect" style="padding: 10px; font-size: 16px; width: 80%;">
        <option value="3,2,1,2,3,3,3,2,2,2,3,5,5,3,2,1,2,3,3,3,3,2,2,3,2,1">ç‘ªè‰æœ‰éš»å°ç¶¿ç¾Šï¼ˆå®Œæ•´ç‰ˆï¼‰</option>
        <option value="1,1,5,5,4,4,5,3,3,2,2,1,5,5,3,3,2,5,5,3,3,2,1,1,5,5,4,4,5,3,3,2,2,1">å°æ˜Ÿæ˜Ÿï¼ˆå®Œæ•´ç‰ˆï¼‰</option>
        <option value="3,3,4,3,5,4,3,3,4,3,1,3,3,5,4,3,2,1,4,4,3,1,2,1">ç”Ÿæ—¥å¿«æ¨‚ï¼ˆå®Œæ•´ç‰ˆï¼‰</option>
        <option value="1,2,3,1,1,2,3,1,3,4,5,3,4,5,5,3,5,5,3,5,1,5,1">å…©éš»è€è™ï¼ˆå®Œæ•´ç‰ˆï¼‰</option>
        <option value="5,3,3,4,2,2,1,2,3,4,5,5,5,2,2,2,2,2,3,4,3,3,3,3,4,5,5,3,3,4,2,2,1">å°èœœèœ‚ï¼ˆå®Œæ•´ç‰ˆï¼‰</option>
        <option value="3,3,4,5,5,4,3,2,1,1,2,3,3,2,2,3,3,4,5,5,4,3,2,1,1,2,3,2,1,1">æ­¡æ¨‚é Œï¼ˆå®Œæ•´ç‰ˆï¼‰</option>
        <option value="1,2,3,4,5,5,4,3,2,1,1,2,3,4,5,5,4,3,2,1">éŸ³éšä¸Šä¸‹ï¼ˆå®Œæ•´ç‰ˆï¼‰</option>
        <option value="1,3,5,3,1,3,5,3,2,4,5,4,2,4,5,4,1,3,5,3">åˆ†è§£å’Œå¼¦ï¼ˆå®Œæ•´ç‰ˆï¼‰</option>
      </select>

      <br><br>
      <button id="startBtn" class="btn-start" onclick="startGame()">é–‹å§‹éŠæˆ²ï¼</button>

      <!-- âœ… æ–°å¢ï¼šå­¸ç¿’æˆæ•ˆè¿½è¹¤ -->
      <br><br>
      <button type="button" onclick="openReport()" style="background:#6f42c1; color:#fff;">ğŸ“ˆ å­¸ç¿’æˆæ•ˆè¿½è¹¤</button>
    </div>

  </div><!-- mainPage end -->

  <div id="gameArea">
    <div class="instruction">çœ‹åˆ°ç‡ˆäº® -> æŒ‰ä¸‹æ­£ç¢ºæŒ‰éˆ•æ‰æœƒç™¼è²ï¼</div>
    <div class="timer"><span id="timeDisplay">0.00</span> ç§’</div>
    <div class="note-display" id="currentNote">-</div>
    <div id="logMsg" style="font-size: 14px; color: #aaa;">ç­‰å¾…æ“ä½œ...</div>
    <br>
    <button onclick="stopGame()" style="background:#dc3545; color:white;">çµæŸéŠæˆ²</button>
  </div>

  <!-- âœ… å ±è¡¨é  -->
  <div id="reportPage" class="box box-wide" style="display:none;">
    <h3>ğŸ“ˆ å­¸ç¿’æˆæ•ˆè¿½è¹¤</h3>

    <div style="display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap;">
      <label>æ­Œæ›²</label>
      <select id="reportSongSelect"
        style="padding:10px; font-size:16px; min-width:260px;"
        onchange="loadReport()">
      <label>é–‹å§‹</label>
<input id="fromDT" type="datetime-local" step="3600"
       style="padding:8px; font-size:14px;">

<label>çµæŸ</label>
<input id="toDT" type="datetime-local" step="3600"
       style="padding:8px; font-size:14px;">
  <label style="margin-left:10px;">æ¨¡å¼</label>
<select id="reportMode" style="padding:10px; font-size:16px;" onchange="loadReport()">
  <option value="daily_best">æ¯å¤©æœ€ä½³(æœ€çŸ­)</option>
  <option value="each_try" selected>æ¯æ¬¡ç´€éŒ„(åˆ°å°æ™‚)</option>
  <option value="hour_best">æ¯å°æ™‚æœ€ä½³</option>
</select>

</select>

   
      <button onclick="backToMain()" style="padding:10px 18px; background:#555; color:#fff;">è¿”å›éŠæˆ²</button>
    </div>

    <div style="margin-top:18px; background:#222; padding:12px; border-radius:10px;">
      <canvas id="reportChart" height="120"></canvas>
    </div>

    <p style="margin-top:10px; color:#aaa; font-size:14px;">
      é¡¯ç¤ºã€Œæ¯å¤©æœ€ä½³ç§’æ•¸ï¼ˆæœ€çŸ­ï¼‰ã€è¶¨å‹¢ï¼šå·¦é‚Š=ç§’æ•¸ã€ä¸‹æ–¹=æ—¥æœŸï¼ˆè¶Šä½è¶Šå¥½ï¼‰
    </p>

    <p id="reportMsg" style="color:#ffcc66;"></p>
  </div>

  <div class="debug-area">
    <p>é™¤éŒ¯è¨Šæ¯: <span id="debugText">ç„¡</span></p>
  </div>

</div>

<script>
/* ================== ç•«é¢åˆ‡æ› ================== */
function showLogin() {
  document.getElementById("app").style.display = "none";
  document.getElementById("loginBox").style.display = "block";
  document.getElementById("addBox").style.display = "block";
  document.getElementById("reportPage").style.display = "none";
}

function showApp() {
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("addBox").style.display = "none";
  document.getElementById("app").style.display = "block";
  showMainPage();
}

function showMainPage() {
  document.getElementById("mainPage").style.display = "block";
  document.getElementById("reportPage").style.display = "none";
}

function openReport() {
  document.getElementById("mainPage").style.display = "none";
  document.getElementById("reportPage").style.display = "block";
  initReportSongList(); // å¡«æ­Œå–®
  loadReport();         // ç•«åœ–
}

function backToMain() {
  showMainPage();
}

/* ================== ç™»å‡º ================== */
function logout() {
  try { stopGame(); } catch(e) {}

  localStorage.removeItem("userId");
  localStorage.removeItem("userName");

  document.getElementById("idInput").value = "";
  document.getElementById("nameInput").value = "";
  document.getElementById("loginMsg").innerText = "";
  document.getElementById("userName").innerText = "---";

  showLogin();
}

/* ================== APIï¼šæŸ¥ç©å®¶ ================== */
async function fetchUserById(id) {
  const res = await fetch(`/test/api/login.php?id=${encodeURIComponent(id)}`, { cache: "no-store" });
  if (!res.ok) return null;
  const data = await res.json();
  return data && data.id ? data : null;
}

/* ================== ç™»å…¥ ================== */
async function login() {
  const id = document.getElementById("idInput").value.trim();
  const msg = document.getElementById("loginMsg");

  if (!id) { msg.innerText = "è«‹è¼¸å…¥ç·¨è™Ÿ"; return; }

  msg.innerText = "æŸ¥è©¢ä¸­...";

  try {
    const user = await fetchUserById(id);
    if (!user) { msg.innerText = "æ‰¾ä¸åˆ°æ­¤ç·¨è™Ÿ"; return; }

    localStorage.setItem("userId", user.id);
    localStorage.setItem("userName", user.name);

    document.getElementById("idInput").value = user.id;
    document.getElementById("nameInput").value = user.name;
    document.getElementById("userName").innerText = `${user.id}ï½œ${user.name}`;

    msg.innerText = "";
    showApp();
  } catch (e) {
    console.error(e);
    msg.innerText = "ç™»å…¥å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰";
  }
}

/* ================== å­˜åˆ†æ•¸ ================== */
async function saveScore(seconds) {
  const playerId = localStorage.getItem("userId");
  const playerName = localStorage.getItem("userName");
  const songName = document.querySelector("#songSelect option:checked")?.textContent || "unknown";

  if (!playerId || !playerName) {
    log("âš ï¸ æœªç™»å…¥ï¼Œç•¥éå­˜åˆ†æ•¸");
    return;
  }

  const res = await fetch(`/test/api/save_score.php`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      player_id: playerId,
      player_name: playerName,
      song_name: songName,
      seconds: Number(seconds)
    })
  });

  const t = await res.text();
  if (!res.ok) log("âŒ å­˜åˆ†æ•¸å¤±æ•—: " + t);
  else log("âœ… å·²å­˜åˆ†æ•¸: " + t);
}

/* ================== æ–°å¢äººå“¡ï¼šå–å¾—ä¸‹ä¸€è™Ÿ ================== */
async function loadNextId() {
  const msg = document.getElementById("addMsg");
  msg.innerText = "";

  try {
    const res = await fetch("/test/api/next_player_id.php", { cache: "no-store" });
    const data = await res.json();

    const idEl = document.getElementById("newId");
    idEl.value = data.next_id || "";
    idEl.readOnly = true;
  } catch (e) {
    console.error(e);
    msg.innerText = "å–å¾—ä¸‹ä¸€è™Ÿå¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰";
  }
}

/* ================== æ–°å¢äººå“¡ï¼šå­˜å› DB ================== */
async function addPlayer() {
  const id = document.getElementById("newId").value.trim();
  const name = document.getElementById("newName").value.trim();
  const msg = document.getElementById("addMsg");

  if (!id) { msg.innerText = "æ²’æœ‰è‡ªå‹•ç·¨è™Ÿ"; return; }
  if (!name) { msg.innerText = "è«‹è¼¸å…¥å§“å"; return; }

  msg.innerText = "å„²å­˜ä¸­...";

  try {
    const res = await fetch("/test/api/add_player.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, name })
    });

    const text = await res.text();
    if (!res.ok) { msg.innerText = "æ–°å¢å¤±æ•—ï¼š" + text; return; }

    msg.innerText = `âœ… æ–°å¢æˆåŠŸï¼ˆ${id}ï½œ${name}ï¼‰`;

    document.getElementById("idInput").value = id;
    document.getElementById("nameInput").value = name;

    document.getElementById("newName").value = "";
    await loadNextId();
  } catch (e) {
    console.error(e);
    msg.innerText = "æ–°å¢å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰";
  }
}

/* ================== è¼¸å…¥ç·¨è™Ÿè‡ªå‹•å¸¶å§“å ================== */
function bindIdAutoFill() {
  const idEl = document.getElementById("idInput");
  const nameEl = document.getElementById("nameInput");
  let timer = null;

  idEl.addEventListener("input", () => {
    clearTimeout(timer);
    timer = setTimeout(async () => {
      const id = idEl.value.trim();
      nameEl.value = "";
      document.getElementById("loginMsg").innerText = "";

      if (!id) return;

      const user = await fetchUserById(id);
      if (user) nameEl.value = user.name || "";
      else document.getElementById("loginMsg").innerText = "æ‰¾ä¸åˆ°æ­¤ç·¨è™Ÿ";
    }, 300);
  });
}

/* ================== BLE / éŠæˆ²å€ï¼ˆä½ åŸæœ¬çš„ï¼‰ ================== */
const LED_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const LED_CHAR = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

const BTN_SERVICE_UUID = "1234c201-1fb5-459e-8fcc-c5c9c331914b";
const BTN_NOTIFY_UUID  = "5678483e-36e1-4688-b7f5-ea07361b26a8";
const BTN_VOL_UUID     = "9012483e-36e1-4688-b7f5-ea07361b26a8";
const BTN_TARGET_UUID  = "3456483e-36e1-4688-b7f5-ea07361b26a8";

let ledChar = null;
let volChar = null;
let targetChar = null;

let isPlaying = false;
let song = [];
let index = 0;
let startTime = 0;
let timerInt = null;

function log(msg) {
  const el = document.getElementById("debugText");
  if (el) el.innerText = msg;
  console.log(msg);
}

async function connectLed() {
  try {
    const dev = await navigator.bluetooth.requestDevice({
      filters: [{ name: "ESP32_LED_Control" }],
      optionalServices: [LED_UUID]
    });
    const srv = await dev.gatt.connect();
    const svc = await srv.getPrimaryService(LED_UUID);
    ledChar = await svc.getCharacteristic(LED_CHAR);

    document.getElementById("ledStatus").innerHTML = "å·²é€£ç·š âœ…";
    document.getElementById("ledStatus").className = "status-ok";
    checkReady();
  } catch (e) {
    alert("LEDé€£ç·šå¤±æ•—: " + e);
  }
}

async function connectBtn() {
  try {
    const dev = await navigator.bluetooth.requestDevice({
      filters: [{ name: "ESP32_Button_Input" }],
      optionalServices: [BTN_SERVICE_UUID]
    });
    const srv = await dev.gatt.connect();
    const svc = await srv.getPrimaryService(BTN_SERVICE_UUID);

    const notifyChar = await svc.getCharacteristic(BTN_NOTIFY_UUID);
    await notifyChar.startNotifications();
    notifyChar.addEventListener("characteristicvaluechanged", onBtnPress);

    try { volChar = await svc.getCharacteristic(BTN_VOL_UUID); updateVolume(25); } catch(e){}
    try { targetChar = await svc.getCharacteristic(BTN_TARGET_UUID); } catch(e){ log("æ‰¾ä¸åˆ° Target ç‰¹å¾µ!"); }

    document.getElementById("btnStatus").innerHTML = "å·²é€£ç·š âœ…";
    document.getElementById("btnStatus").className = "status-ok";
    checkReady();
  } catch (e) {
    alert("æŒ‰éˆ•é€£ç·šå¤±æ•—: " + e);
  }
}

function checkReady() {
  if (ledChar || document.getElementById("btnStatus").className.includes("status-ok")) {
    document.getElementById("hardwareTest").style.display = "block";
  }
  if (ledChar && document.getElementById("btnStatus").className.includes("status-ok")) {
    document.getElementById("startBtn").style.display = "inline-block";
  }
}

function testLed(num) {
  if (ledChar) ledChar.writeValue(new TextEncoder().encode(String(num)));
  else alert("LEDæ¿å°šæœªé€£ç·šï¼");
}

function toggleSoundTest(checkbox) {
  if (!targetChar) { alert("æŒ‰éˆ•æ¿å°šæœªé€£ç·šï¼"); checkbox.checked = false; return; }
  if (checkbox.checked) {
    targetChar.writeValue(new TextEncoder().encode("99"));
    log("é–‹å•Ÿè²éŸ³æ¸¬è©¦ (è‡ªç”±æ¨¡å¼)");
  } else {
    targetChar.writeValue(new TextEncoder().encode("0"));
    log("é—œé–‰è²éŸ³æ¸¬è©¦");
  }
}

function updateVolume(val) {
  document.getElementById("volVal").innerText = val;
  if (volChar) volChar.writeValue(new TextEncoder().encode(String(val)));
}

function startGame() {
  document.getElementById("soundTestToggle").checked = false;

  song = document.getElementById("songSelect").value
    .split(",")
    .map(s => s.trim())
    .filter(s => s !== "")
    .map(Number);

  index = 0;
  isPlaying = true;

  document.getElementById("controlBox").style.display = "none";
  document.getElementById("hardwareTest").style.display = "none";
  document.getElementById("gameArea").style.display = "block";

  startTime = Date.now();
  timerInt = setInterval(() => {
    const t = (Date.now() - startTime) / 1000;
    document.getElementById("timeDisplay").innerText = t.toFixed(2);
  }, 30);

  playNote();
}

function stopGame() {
  if (timerInt) {
    clearInterval(timerInt);
    timerInt = null;
  }

  isPlaying = false;

  // âœ… é—œè²éŸ³
  if (targetChar) {
    targetChar.writeValue(new TextEncoder().encode("0"));
  }

  // âœ… é—œç‡ˆï¼ˆé‡é»ï¼‰
  turnOffLed();

  document.getElementById("gameArea").style.display = "none";
  document.getElementById("controlBox").style.display = "block";
  document.getElementById("hardwareTest").style.display = "block";
}


function playNote() {
  if (index >= song.length) {
    if (timerInt) { clearInterval(timerInt); timerInt = null; }
    if (targetChar) targetChar.writeValue(new TextEncoder().encode("0"));
    setTimeout(finishGame, 300);
    return;
  }

  const target = song[index];
  document.getElementById("currentNote").innerText = target;
  document.getElementById("logMsg").innerText = "ç›®æ¨™: " + target;

  if (ledChar) ledChar.writeValue(new TextEncoder().encode(String(target)));
  if (targetChar) targetChar.writeValue(new TextEncoder().encode(String(target)));
  else log("è­¦å‘Š: ç„¡æ³•è¨­å®š Targetï¼Œè²éŸ³å¯èƒ½ä¸æœƒå‡ºä¾†");
}

function onBtnPress(event) {
  const val = new TextDecoder().decode(event.target.value);
  const pressed = parseInt(val, 10);

  document.getElementById("lastPressed").innerText = pressed;
  if (!isPlaying) return;

  const target = song[index];
  if (pressed === target) {
    index++;
    setTimeout(playNote, 50);
  } else {
    document.getElementById("logMsg").innerText = "âŒ æŒ‰éŒ¯äº†ï¼(éœéŸ³)";
  }
}

async function finishGame() {
  isPlaying = false;
  if (ledChar) ledChar.writeValue(new TextEncoder().encode("0"));

  const seconds = parseFloat(document.getElementById("timeDisplay").innerText) || 0;
  await saveScore(seconds);

  document.getElementById("currentNote").innerText = "ğŸ‰";
  setTimeout(() => {
    alert("æ­å–œå®Œæˆï¼ç¸½æ™‚é–“: " + seconds.toFixed(2) + " ç§’");
    stopGame();
  }, 200);
}

/* ================== âœ… å­¸ç¿’æˆæ•ˆè¿½è¹¤ï¼ˆå ±è¡¨ï¼‰ ================== */
let progressChart = null;

async function initReportSongList() {
  const sel = document.getElementById("reportSongSelect");
  if (!sel) return;

  sel.innerHTML = "";

  // å…¨éƒ¨æ­Œæ›²
  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "å…¨éƒ¨æ­Œæ›²";
  sel.appendChild(optAll);

  try {
    const res = await fetch("/test/api/get_songs.php", { cache: "no-store" });
    if (!res.ok) throw new Error(await res.text());
    const rows = await res.json();

    rows.forEach(r => {
      const name = r.song_name || r.name || r.song || "";
      if (!name) return;
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    });
  } catch (e) {
    console.error(e);
  }
}

// æŠŠæ—¥æœŸå­—ä¸²è½‰æˆ YYYY-MM-DD
function toYMD(anyDateStr) {
  if (!anyDateStr) return null;

  // å¯èƒ½æ˜¯ "2026-01-30 12:34:56" æˆ– "2026/01/30"
  const s = String(anyDateStr).replace(/\//g, "-");
  const m = s.match(/^(\d{4}-\d{2}-\d{2})/);
  if (m) return m[1];

  // å¯èƒ½æ˜¯ timestamp
  const n = Number(anyDateStr);
  if (!isNaN(n) && n > 1000000000) {
    const d = new Date(n * (n < 2000000000 ? 1000 : 1)); // ç§’/æ¯«ç§’å®¹éŒ¯
    return d.toISOString().slice(0, 10);
  }
  return null;
}

function pickSeconds(row) {
  // é€™è£¡åšå®¹éŒ¯ï¼šä½  DB æ¬„ä½å« seconds / best_time / time / score éƒ½å¯ä»¥
  const candidates = ["best_time", "seconds", "time", "score", "duration"];
  for (const k of candidates) {
    if (row[k] != null && row[k] !== "") return Number(row[k]);
  }
  // æœ‰äº›äººæœƒåŒ…åœ¨ row.value
  if (row.value != null) return Number(row.value);
  return NaN;
}

function pickDate(row) {
  const candidates = ["play_date", "created_at", "date", "created", "time"];
  for (const k of candidates) {
    const v = toYMD(row[k]);
    if (v) return v;
  }
  return null;
}

function turnOffLed() {
  if (ledChar) {
    try {
      ledChar.writeValue(new TextEncoder().encode("0"));
    } catch (e) {
      console.warn("é—œç‡ˆå¤±æ•—", e);
    }
  }
}
    
async function loadReport() {
  const msgEl = document.getElementById("reportMsg");
  if (msgEl) msgEl.textContent = "";

  const playerId = localStorage.getItem("userId");
  if (!playerId) {
    if (msgEl) msgEl.textContent = "âš ï¸ å°šæœªç™»å…¥";
    return;
  }

  const songName = document.getElementById("reportSongSelect")?.value ?? "";
  const fromDT = document.getElementById("fromDT")?.value || "";
  const toDT   = document.getElementById("toDT")?.value || "";
  const mode   = document.getElementById("reportMode")?.value || "daily_best";

  const url = `/test/api/get_scores.php?player_id=${encodeURIComponent(playerId)}`
    + `&song_name=${encodeURIComponent(songName)}`
    + `&from=${encodeURIComponent(fromDT)}`
    + `&to=${encodeURIComponent(toDT)}`;

  let rows = [];
  try {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(await res.text());
    rows = await res.json();
    if (!Array.isArray(rows)) rows = [];
  } catch (e) {
    console.error(e);
    if (msgEl) msgEl.textContent = "âŒ è®€å–æˆç¸¾å¤±æ•—ï¼ˆè«‹çœ‹ Console / Network Responseï¼‰";
    return;
  }

  // âœ… å°‡è³‡æ–™æ¨™æº–åŒ–ï¼ˆä½  DB æ¬„ä½å°±æ˜¯ seconds / created_atï¼‰
  const parsed = rows
    .map(r => ({
      seconds: Number(r.seconds ?? r.best_time ?? r.time ?? r.score),
      created_at: String(r.created_at ?? r.play_date ?? r.date ?? "")
    }))
    .filter(x => !isNaN(x.seconds) && x.created_at);

  // âœ… ä¾æ¨¡å¼ç”¢ç”Ÿ labels/data
  let labels = [];
  let data = [];
  let xTitle = "æ—¥æœŸ";

  if (mode === "daily_best") {
    // æ¯å¤©æœ€ä½³ï¼ˆæœ€çŸ­ï¼‰
    const bestByDate = new Map(); // YYYY-MM-DD -> bestSeconds
    for (const it of parsed) {
      const d = it.created_at.slice(0, 10); // 2026-01-30
      const prev = bestByDate.get(d);
      if (prev == null || it.seconds < prev) bestByDate.set(d, it.seconds);
    }
    labels = Array.from(bestByDate.keys()).sort();
    data = labels.map(d => bestByDate.get(d));
    xTitle = "æ—¥æœŸ";

  } else if (mode === "each_try") {
    // æ¯æ¬¡ç´€éŒ„ï¼ˆåˆ°ã€Œå°æ™‚ã€ï¼‰
    parsed.sort((a, b) => a.created_at.localeCompare(b.created_at));
    labels = parsed.map(it => it.created_at.slice(0, 13)); // "2026-01-30 15"
    data = parsed.map(it => it.seconds);
    xTitle = "æ—¥æœŸ(åˆ°å°æ™‚)";

  } else if (mode === "hour_best") {
    // æ¯å°æ™‚æœ€ä½³ï¼ˆæœ€çŸ­ï¼‰
    const bestByHour = new Map(); // "YYYY-MM-DD HH" -> bestSeconds
    for (const it of parsed) {
      const h = it.created_at.slice(0, 13); // 2026-01-30 15
      const prev = bestByHour.get(h);
      if (prev == null || it.seconds < prev) bestByHour.set(h, it.seconds);
    }
    labels = Array.from(bestByHour.keys()).sort();
    data = labels.map(h => bestByHour.get(h));
    xTitle = "æ—¥æœŸ(åˆ°å°æ™‚)";
  }

  const canvas = document.getElementById("reportChart");
  if (!canvas) return;

  if (progressChart) {
    progressChart.destroy();
    progressChart = null;
  }

  if (labels.length === 0) {
    if (msgEl) msgEl.textContent = "ç›®å‰æ²’æœ‰è³‡æ–™ï¼ˆè«‹èª¿æ•´æ™‚é–“ç¯„åœæˆ–å…ˆç©ä¸€å±€å†çœ‹ï¼‰";
    // æ²’è³‡æ–™å°±ç•«ç©ºåœ–ï¼ˆé¿å…ç•™è‘—èˆŠåœ–èª¤æœƒï¼‰
    progressChart = new Chart(canvas, {
      type: "line",
      data: { labels: [], datasets: [{ label: "æ²’æœ‰è³‡æ–™", data: [] }] },
      options: { responsive: true }
    });
    return;
  }

  progressChart = new Chart(canvas, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label:
          mode === "daily_best" ? "æ¯å¤©æœ€ä½³ç§’æ•¸ï¼ˆè¶Šä½è¶Šå¥½ï¼‰" :
          mode === "hour_best"  ? "æ¯å°æ™‚æœ€ä½³ç§’æ•¸ï¼ˆè¶Šä½è¶Šå¥½ï¼‰" :
                                  "æ¯æ¬¡ç§’æ•¸ï¼ˆè¶Šä½è¶Šå¥½ï¼‰",
        data,
        borderWidth: 2,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { title: { display: true, text: "ç§’æ•¸" } },
        x: {
          title: { display: true, text: xTitle },
          ticks: { autoSkip: true, maxRotation: 0 }
        }
      }
    }
  });
}


/* ================== é é¢è¼‰å…¥ ================== */
window.addEventListener("load", () => {
  bindIdAutoFill();
  loadNextId();
  initReportSongList();

  const savedId = localStorage.getItem("userId");
  const savedName = localStorage.getItem("userName");
  document.getElementById("fromDT").addEventListener("change", loadReport);
  document.getElementById("toDT").addEventListener("change", loadReport);

  if (savedId && savedName) {
    document.getElementById("userName").innerText = `${savedId}ï½œ${savedName}`;
    showApp();
  } else {
    showLogin();
  }
});
</script>

</body>
</html>
