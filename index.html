<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 é‹¼ç´éŠæˆ² (å«æ¸¬è©¦åŠŸèƒ½)</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; text-align: center; background: #222; color: white; padding-top: 20px;}
        .box { border: 1px solid #555; padding: 20px; margin: 15px auto; max-width: 500px; border-radius: 10px; background: #333; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; border: none; margin: 5px;}
        .btn-connect { background: #007bff; color: white; }
        .btn-start { background: #28a745; color: white; font-size: 24px; padding: 15px 40px; display: none;}
        .status-ok { color: #4cff00; font-weight: bold; }
        
        /* æ¸¬è©¦å€æ¨£å¼ */
        .test-panel { background: #444; padding: 10px; border-radius: 5px; margin-top: 10px; display:none; border: 1px dashed #777;}
        .test-btn { background: #666; color: white; font-size: 14px; padding: 8px 15px; }
        .test-btn:active { background: #888; }
        
        #gameArea { display: none; margin-top: 30px; }
        .timer { font-size: 40px; color: #00d2ff; font-family: monospace; }
        .note-display { font-size: 80px; color: yellow; font-weight: bold; margin: 20px 0; }
        .instruction { color: #ff9999; font-size: 18px; margin-bottom: 10px;}
        
        .vol-container { margin: 20px 0; padding: 15px; background: #444; border-radius: 5px; border: 1px solid #666; }
        input[type=range] { width: 80%; cursor: pointer; }
        
        .debug-area { margin-top: 50px; border-top: 1px solid #555; padding-top: 20px; color: gray; font-size: 0.8em; }
    </style>
</head>
<body>
<div id="loginBox">
  <input id="idInput" placeholder="è¼¸å…¥ç·¨è™Ÿ" />
  <input id="nameInput" placeholder="ç©å®¶å§“å" readonly />
  <button onclick="login()">ç™»å…¥</button>
  <p id="loginMsg"></p>
</div>
<div id="addBox" style="margin-top:20px;">
  <h3 style="color:#fff;">â• æ–°å¢äººå“¡</h3>

  <div style="display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap;">
    <input id="newId" placeholder="è‡ªå‹•ç·¨è™Ÿ" readonly style="width:160px; padding:8px;">
    <input id="newName" placeholder="è¼¸å…¥å§“å" style="width:200px; padding:8px;">
    <button onclick="addPlayer()" style="padding:10px 18px;">å„²å­˜</button>
  </div>

  <p id="addMsg" style="margin-top:10px; color:#ffd966;"></p>
</div>

  <div id="app" style="display:none;">
  
    <h1>ğŸµ ESP32 é‹¼ç´æŒ‘æˆ° (æ¸¬è©¦ç‰ˆ)</h1>
    <h2>ğŸ‘¤ ç©å®¶ï¼š<span id="userName">---</span> 
        <button type="button" onclick="logout()">ç™»å‡º</button>

    </h2>


    <div class="box">
        <h3>1. è£ç½®é€£ç·šèˆ‡æ¸¬è©¦</h3>
        <p>LEDæ¿: <span id="ledStatus">æœªé€£ç·š âŒ</span> <button class="btn-connect" onclick="connectLed()">é€£æ¥</button></p>
        <p>æŒ‰éˆ•æ¿: <span id="btnStatus">æœªé€£ç·š âŒ</span> <button class="btn-connect" onclick="connectBtn()">é€£æ¥</button></p>
        
        <div id="hardwareTest" class="test-panel">
            <h4>ğŸ”§ ç¡¬é«”æ¸¬è©¦å€</h4>
            <p>æ¸¬è©¦ç‡ˆè™Ÿ (é»æ“Šäº®ç‡ˆ):</p>
            <button class="test-btn" onclick="testLed(1)">1 (è—)</button>
            <button class="test-btn" onclick="testLed(2)">2 (ç´…)</button>
            <button class="test-btn" onclick="testLed(3)">3 (é»ƒ)</button>
            <button class="test-btn" onclick="testLed(4)">4 (ç¶ )</button>
            <button class="test-btn" onclick="testLed(5)">5 (ç™½)</button>
            <button class="test-btn" onclick="testLed(0)">é—œç‡ˆ</button>
            
            <p style="margin-top:15px; border-top:1px solid #666; padding-top:10px;">
                æ¸¬è©¦è²éŸ³èˆ‡æŒ‰éˆ•:<br>
                <label style="font-size:18px; color:#00d2ff;">
                    <input type="checkbox" id="soundTestToggle" onchange="toggleSoundTest(this)"> 
                    é–‹å•Ÿè²éŸ³æ¸¬è©¦ (è‡ªç”±ç™¼è²)
                </label>
            </p>
            <p>æœ€å¾ŒæŒ‰ä¸‹çš„æŒ‰éˆ•: <span id="lastPressed" style="font-size:24px; color:yellow; font-weight:bold;">-</span></p>

            <div style="margin-top:10px;">
                ğŸ”Š éŸ³é‡: <span id="volVal">25</span>%
                <br>
                <input type="range" min="0" max="100" value="25" oninput="updateVolume(this.value)">
            </div>
        </div>
    </div>
 

    <div class="box" id="controlBox">
        <h3>2. é¸æ“‡é—œå¡ (éŠæˆ²é–‹å§‹)</h3>
        <select id="songSelect" style="padding: 10px; font-size: 16px; width: 80%;">
            <!-- ç‘ªè‰æœ‰éš»å°ç¶¿ç¾Šï¼ˆå®Œæ•´ç‰ˆï¼‰ -->
<option value="
3,2,1,2,3,3,3,
2,2,2,
3,5,5,
3,2,1,2,3,3,3,
3,2,2,3,2,1
">ç‘ªè‰æœ‰éš»å°ç¶¿ç¾Šï¼ˆå®Œæ•´ç‰ˆï¼‰</option>

<!-- å°æ˜Ÿæ˜Ÿï¼ˆå®Œæ•´ç‰ˆï¼‰ -->
<option value="
1,1,5,5,4,4,5,
3,3,2,2,1,
5,5,3,3,2,
5,5,3,3,2,
1,1,5,5,4,4,5,
3,3,2,2,1
">å°æ˜Ÿæ˜Ÿï¼ˆå®Œæ•´ç‰ˆï¼‰</option>

<!-- ç”Ÿæ—¥å¿«æ¨‚ï¼ˆå®Œæ•´ç‰ˆï¼‰ -->
<option value="
3,3,4,3,5,4,
3,3,4,3,1,
3,3,5,4,3,2,1,
4,4,3,1,2,1
">ç”Ÿæ—¥å¿«æ¨‚ï¼ˆå®Œæ•´ç‰ˆï¼‰</option>

<!-- å…©éš»è€è™ï¼ˆå®Œæ•´ç‰ˆï¼‰ -->
<option value="
1,2,3,1,
1,2,3,1,
3,4,5,
3,4,5,
5,3,5,
5,3,5,
1,5,1
">å…©éš»è€è™ï¼ˆå®Œæ•´ç‰ˆï¼‰</option>

<!-- å°èœœèœ‚ï¼ˆå®Œæ•´ç‰ˆï¼‰ -->
<option value="
5,3,3,4,2,2,
1,2,3,4,5,5,5,
2,2,2,2,2,
3,4,3,3,3,
3,4,5,5,
3,3,4,2,2,
1
">å°èœœèœ‚ï¼ˆå®Œæ•´ç‰ˆï¼‰</option>

<!-- æ­¡æ¨‚é Œï¼ˆå®Œæ•´ç‰ˆï¼Œäº”éŸ³åŸŸç‰ˆï¼‰ -->
<option value="
3,3,4,5,
5,4,3,2,
1,1,2,3,
3,2,2,
3,3,4,5,
5,4,3,2,
1,1,2,3,
2,1,1
">æ­¡æ¨‚é Œï¼ˆå®Œæ•´ç‰ˆï¼‰</option>

<!-- éŸ³éšä¸Šä¸‹å®Œæ•´ç·´ç¿’ -->
<option value="
1,2,3,4,5,
5,4,3,2,1,
1,2,3,4,5,
5,4,3,2,1
">éŸ³éšä¸Šä¸‹ï¼ˆå®Œæ•´ç‰ˆï¼‰</option>

<!-- åˆ†è§£å’Œå¼¦å®Œæ•´ç·´ç¿’ -->
<option value="
1,3,5,3,
1,3,5,3,
2,4,5,4,
2,4,5,4,
1,3,5,3
">åˆ†è§£å’Œå¼¦ï¼ˆå®Œæ•´ç‰ˆï¼‰</option>

        </select>
        <br><br>
        <button id="startBtn" class="btn-start" onclick="startGame()">é–‹å§‹éŠæˆ²ï¼</button>
    </div>

    <div id="gameArea">
        <div class="instruction">çœ‹åˆ°ç‡ˆäº® -> æŒ‰ä¸‹æ­£ç¢ºæŒ‰éˆ•æ‰æœƒç™¼è²ï¼</div>
        <div class="timer"><span id="timeDisplay">0.00</span> ç§’</div>
        <div class="note-display" id="currentNote">-</div>
        <div id="logMsg" style="font-size: 14px; color: #aaa;">ç­‰å¾…æ“ä½œ...</div>
        <br>
        <button onclick="stopGame()" style="background:#dc3545; color:white;">çµæŸéŠæˆ²</button>
    </div>

    <div class="debug-area">
        <p>é™¤éŒ¯è¨Šæ¯: <span id="debugText">ç„¡</span></p>
    </div>
</div>

<script>
function showLogin() {
  document.getElementById("app").style.display = "none";
  document.getElementById("loginBox").style.display = "block";
}

function showApp() {
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("app").style.display = "block";
}

function logout(){
  try { stopGame(); } catch(e) {}

  // æ¸… localStorage
  localStorage.removeItem("userId");
  localStorage.removeItem("userName");

  // ğŸ”¹ æ¸…ç™»å…¥è¼¸å…¥æ¡†
  document.getElementById("accountInput").value = "";
  document.getElementById("nameInput").value = "";

  // ğŸ”¹ æ¸…ç™»å…¥è¨Šæ¯
  document.getElementById("loginMsg").innerText = "";

  // ğŸ”¹ æ¸…ä¸Šæ–¹ç©å®¶é¡¯ç¤º
  document.getElementById("userName").innerText = "---";

  // ğŸ”¹ åˆ‡å›ç™»å…¥ç•«é¢
  showLogin();
}



async function saveScore(seconds) {
  console.log("[saveScore] seconds=", seconds);
  const playerId = localStorage.getItem("userId");
  const playerName = localStorage.getItem("userName");
  const songName = document.querySelector("#songSelect option:checked")?.textContent || "unknown";

  if(!playerId || !playerName) return;

  const res = await fetch(`/test/api/save_score.php`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      player_id: playerId,
      player_name: playerName,
      song_name: songName,
      seconds: Number(seconds)
    })
  });

  if(!res.ok){
    const t = await res.text();
    log("å­˜åˆ†æ•¸å¤±æ•—: " + t);
  }else{
    const t = await res.text();
    log("å·²å­˜åˆ†æ•¸: " + t);
  }
}

async function fetchUserById(id) {
  const res = await fetch(`/test/api/login.php?id=${encodeURIComponent(id)}`, { cache: "no-store" });
  if(!res.ok) return null;

  const data = await res.json();
  return data && data.id ? data : null;
}

async function login() {
  const id = document.getElementById("idInput").value.trim();
  const name = document.getElementById("nameInput").value.trim();
  const msg = document.getElementById("loginMsg");

  if (!id && !name) {
    msg.innerText = "è«‹è¼¸å…¥ç·¨è™Ÿæˆ–å§“å";
    return;
  }

  msg.innerText = "æŸ¥è©¢ä¸­...";

  try {
    const res = await fetch(
      `/test/api/login.php?id=${encodeURIComponent(id)}&name=${encodeURIComponent(name)}`,
      { cache: "no-store" }
    );

    if (!res.ok) {
      msg.innerText = "æŸ¥è©¢å¤±æ•—";
      return;
    }

    const user = await res.json();

    if (!user) {
      msg.innerText = "æ‰¾ä¸åˆ°æ­¤ç©å®¶";
      return;
    }

    // âœ… å­˜èµ·ä¾†
    localStorage.setItem("userId", user.id);
    localStorage.setItem("userName", user.name);

    // âœ… è‡ªå‹•å¸¶å‡º
    document.getElementById("idInput").value = user.id;
    document.getElementById("nameInput").value = user.name;
    document.getElementById("userName").innerText = `${user.id}ï½œ${user.name}`;

    showApp();

    msg.innerText = "";

  } catch (e) {
    console.error(e);
    msg.innerText = "ç™»å…¥éŒ¯èª¤ï¼ˆè«‹çœ‹ Consoleï¼‰";
  }
}


    const LED_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const LED_CHAR = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
    
    const BTN_SERVICE_UUID = "1234c201-1fb5-459e-8fcc-c5c9c331914b";
    const BTN_NOTIFY_UUID  = "5678483e-36e1-4688-b7f5-ea07361b26a8"; 
    const BTN_VOL_UUID     = "9012483e-36e1-4688-b7f5-ea07361b26a8";
    const BTN_TARGET_UUID  = "3456483e-36e1-4688-b7f5-ea07361b26a8"; 

    let ledChar = null;
    let volChar = null; 
    let targetChar = null;
    
    let isPlaying = false;
    let song = [];
    let index = 0;
    let startTime = 0;
    let timerInt = null;

    function log(msg) { document.getElementById('debugText').innerText = msg; console.log(msg); }

    async function connectLed() {
        try {
            const dev = await navigator.bluetooth.requestDevice({filters: [{name:'ESP32_LED_Control'}], optionalServices:[LED_UUID]});
            const srv = await dev.gatt.connect();
            const svc = await srv.getPrimaryService(LED_UUID);
            ledChar = await svc.getCharacteristic(LED_CHAR);
            document.getElementById('ledStatus').innerHTML = "å·²é€£ç·š âœ…";
            document.getElementById('ledStatus').className = "status-ok";
            checkReady();
        } catch(e){ alert("LEDé€£ç·šå¤±æ•—: " + e); }
    }

    async function connectBtn() {
        try {
            const dev = await navigator.bluetooth.requestDevice({filters: [{name:'ESP32_Button_Input'}], optionalServices:[BTN_SERVICE_UUID]});
            const srv = await dev.gatt.connect();
            const svc = await srv.getPrimaryService(BTN_SERVICE_UUID);
            
            const notifyChar = await svc.getCharacteristic(BTN_NOTIFY_UUID);
            await notifyChar.startNotifications();
            notifyChar.addEventListener('characteristicvaluechanged', onBtnPress);
            
            try { volChar = await svc.getCharacteristic(BTN_VOL_UUID); updateVolume(25); } catch(e){}
            try { targetChar = await svc.getCharacteristic(BTN_TARGET_UUID); } catch(e){ log("æ‰¾ä¸åˆ° Target ç‰¹å¾µ!"); }

            document.getElementById('btnStatus').innerHTML = "å·²é€£ç·š âœ…";
            document.getElementById('btnStatus').className = "status-ok";
            checkReady();
        } catch(e){ alert("æŒ‰éˆ•é€£ç·šå¤±æ•—: " + e); }
    }

    function checkReady() {
        // åªè¦é€£ä¸Šä»»ä¸€å€‹è£ç½®ï¼Œå°±é¡¯ç¤ºæ¸¬è©¦å€
        if(ledChar || document.getElementById('btnStatus').className.includes("status-ok")){
            document.getElementById('hardwareTest').style.display = 'block';
        }
        // å…©å€‹éƒ½é€£ä¸Šæ‰èƒ½é–‹å§‹éŠæˆ²
        if(ledChar && document.getElementById('btnStatus').className.includes("status-ok")){
            document.getElementById('startBtn').style.display = "inline-block";
        }
    }

    // --- ç¡¬é«”æ¸¬è©¦åŠŸèƒ½ ---
    function testLed(num) {
        if(ledChar) ledChar.writeValue(new TextEncoder().encode(String(num)));
        else alert("LEDæ¿å°šæœªé€£ç·šï¼");
    }

    function toggleSoundTest(checkbox) {
        if(!targetChar) { alert("æŒ‰éˆ•æ¿å°šæœªé€£ç·šï¼"); checkbox.checked = false; return; }
        
        if(checkbox.checked) {
            // ç™¼é€ 99 çµ¦ ESP32ï¼Œé–‹å•Ÿè‡ªç”±ç™¼è²æ¨¡å¼
            targetChar.writeValue(new TextEncoder().encode("99"));
            log("é–‹å•Ÿè²éŸ³æ¸¬è©¦ (è‡ªç”±æ¨¡å¼)");
        } else {
            // ç™¼é€ 0ï¼ŒéœéŸ³æ¨¡å¼
            targetChar.writeValue(new TextEncoder().encode("0"));
            log("é—œé–‰è²éŸ³æ¸¬è©¦");
        }
    }

    function updateVolume(val) {
        document.getElementById('volVal').innerText = val;
        if(volChar) volChar.writeValue(new TextEncoder().encode(String(val)));
    }

    // --- éŠæˆ²é‚è¼¯ ---
    function startGame() {
        // é–‹å§‹éŠæˆ²å‰ï¼Œå…ˆæŠŠæ¸¬è©¦é–‹é—œé—œæ‰ï¼Œé¿å…è¡çª
        document.getElementById('soundTestToggle').checked = false;
        
        song = document.getElementById('songSelect').value
          .split(',')
          .map(s => s.trim())
          .filter(s => s !== "")
          .map(Number);

        index = 0;
        isPlaying = true;
        document.getElementById('controlBox').style.display = 'none';
        document.getElementById('hardwareTest').style.display = 'none'; // éš±è—æ¸¬è©¦å€
        document.getElementById('gameArea').style.display = 'block';
        
        startTime = Date.now();
        timerInt = setInterval(() => {
            let t = (Date.now() - startTime) / 1000;
            document.getElementById('timeDisplay').innerText = t.toFixed(2);
        }, 30);
        playNote();
    }

    function stopGame() {
  // âœ… åœæ‰è¨ˆæ™‚å™¨
  if (timerInt) {
    clearInterval(timerInt);
    timerInt = null;
  }

  isPlaying = false;
  if(targetChar) targetChar.writeValue(new TextEncoder().encode("0")); // éœéŸ³

  document.getElementById('gameArea').style.display = 'none';
  document.getElementById('controlBox').style.display = 'block';
  document.getElementById('hardwareTest').style.display = 'block';
}


    function playNote() {
        if(index >= song.length) {
            clearInterval(timerInt);
            if(targetChar) targetChar.writeValue(new TextEncoder().encode("0")); // çµæŸå¾ŒéœéŸ³
            setTimeout(finishGame, 1000);
            return;
        }
        let target = song[index];
        document.getElementById('currentNote').innerText = target;
        document.getElementById('logMsg').innerText = "ç›®æ¨™: " + target;
        
        // 1. äº®ç‡ˆ
        if(ledChar) ledChar.writeValue(new TextEncoder().encode(String(target)));
        // 2. è¨­å®šæŒ‰éˆ•æ¿çš„æ­£ç¢ºç­”æ¡ˆ
        if(targetChar) targetChar.writeValue(new TextEncoder().encode(String(target)));
        else log("è­¦å‘Š: ç„¡æ³•è¨­å®š Targetï¼Œè²éŸ³å¯èƒ½ä¸æœƒå‡ºä¾†");
    }

    function onBtnPress(event) {
        let val = new TextDecoder().decode(event.target.value);
        let pressed = parseInt(val);
        
        // æ›´æ–°æ¸¬è©¦å€é¡¯ç¤º
        document.getElementById('lastPressed').innerText = pressed;

        if(!isPlaying) return; // å¦‚æœæ²’åœ¨ç©éŠæˆ²ï¼Œå°±åªæ›´æ–°é¡¯ç¤º

        let target = song[index];
        log("æ”¶åˆ°: " + pressed + " ç›®æ¨™: " + target);

        if(pressed === target) {
            index++;
            setTimeout(playNote, 50); 
        } else {
            document.getElementById('logMsg').innerText = "âŒ æŒ‰éŒ¯äº†ï¼(éœéŸ³)";
        }
    }

async function finishGame() {
  console.log("[finishGame] called");
  isPlaying = false;
  if(ledChar) ledChar.writeValue(new TextEncoder().encode('0'));

  const seconds = parseFloat(document.getElementById('timeDisplay').innerText) || 0;

  // å­˜åˆ° MySQL
  await saveScore(seconds);

  document.getElementById('currentNote').innerText = "ğŸ‰";
  setTimeout(() => {
    alert("æ­å–œå®Œæˆï¼ç¸½æ™‚é–“: " + seconds.toFixed(2) + " ç§’");
    stopGame();
  }, 300);
}

window.addEventListener("load", () => {
  const savedId = localStorage.getItem("userId");
  const savedName = localStorage.getItem("userName");
  if(savedId && savedName){
    document.getElementById("userName").innerText = savedName;
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("app").style.display = "block";
  }
});

window.addEventListener("load", () => {
  const idEl = document.getElementById("idInput");
  const nameEl = document.getElementById("nameInput");

  // ä½ åŸæœ¬çš„è‡ªå‹•ç™»å…¥é¡¯ç¤ºä¹Ÿæ”¾é€™è£¡
  const savedId = localStorage.getItem("userId");
  const savedName = localStorage.getItem("userName");
  if (savedId && savedName) {
    document.getElementById("userName").innerText = savedName;
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("app").style.display = "block";
  }

  // âœ… è¼¸å…¥ç·¨è™Ÿå°±è‡ªå‹•å¸¶åå­—ï¼ˆåœ 300ms å†æŸ¥ï¼Œé¿å…æ¯æ‰“ä¸€å€‹å­—å°±æŸ¥ï¼‰
  let t = null;
  idEl.addEventListener("input", () => {
    clearTimeout(t);
    t = setTimeout(async () => {
      const id = idEl.value.trim();
      nameEl.value = "";
      document.getElementById("loginMsg").innerText = "";

      if (!id) return;

      const user = await fetchUserById(id);
      if (user) {
        nameEl.value = user.name || "";
      } else {
        // æ‰¾ä¸åˆ°å°±é¡¯ç¤ºæç¤ºï¼ˆä½ æƒ³è¦å°±ç•™ï¼Œä¸æƒ³è¦å°±åˆªï¼‰
        document.getElementById("loginMsg").innerText = "æ‰¾ä¸åˆ°æ­¤ç·¨è™Ÿ";
      }
    }, 300);
  });
});
async function fetchUserById(id) {
  const res = await fetch(`./api/login.php?id=${encodeURIComponent(id)}`, { cache: "no-store" });
  if(!res.ok) return null;
  const data = await res.json();
  return data && data.id ? data : null;
}
async function login() {
  const idEl = document.getElementById("idInput");
  const nameEl = document.getElementById("nameInput");
  const msg = document.getElementById("loginMsg");

  const acc = idEl.value.trim();
  if (!acc) { msg.innerText = "è«‹è¼¸å…¥ç·¨è™Ÿ"; return; }

  msg.innerText = "æŸ¥è©¢ä¸­...";

  try {
    const user = await fetchUserById(acc);
    if (!user) { msg.innerText = "æ­¤ç·¨è™Ÿä¸å­˜åœ¨"; return; }

    // âœ… å¸¶å‡ºåå­—ï¼ˆä»¥è³‡æ–™åº«ç‚ºæº–ï¼‰
    nameEl.value = user.name || "";

    localStorage.setItem("userId", user.id);
    localStorage.setItem("userName", user.name);

    document.getElementById("userName").innerText = user.name;

    document.getElementById("loginBox").style.display = "none";
    document.getElementById("app").style.display = "block";
    msg.innerText = "";
  } catch (e) {
    console.error(e);
    msg.innerText = "ç™»å…¥å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰";
  }
}

async function loadNextId(){
  const msg = document.getElementById("addMsg");
  msg.innerText = "";

  try{
    const res = await fetch("/test/api/next_player_id.php", { cache:"no-store" });
    if(!res.ok) throw new Error("next id api failed");
    const data = await res.json();
    document.getElementById("newId").value = data.next_id || "";
  }catch(e){
    console.error(e);
    msg.innerText = "å–å¾—ä¸‹ä¸€è™Ÿå¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰";
  }
}
async function addPlayer(){
  const id = document.getElementById("newId").value.trim();
  const name = document.getElementById("newName").value.trim();
  const msg = document.getElementById("addMsg");

  if(!id){ msg.innerText = "æ²’æœ‰è‡ªå‹•ç·¨è™Ÿ"; return; }
  if(!name){ msg.innerText = "è«‹è¼¸å…¥å§“å"; return; }

  msg.innerText = "å„²å­˜ä¸­...";

  try{
    const res = await fetch("/test/api/add_player.php", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ id, name })
    });

    const text = await res.text();

    if(!res.ok){
      msg.innerText = "æ–°å¢å¤±æ•—: " + text;
      return;
    }

    msg.innerText = "âœ… æ–°å¢æˆåŠŸï¼ç·¨è™Ÿ=" + id + "ï¼Œå§“å=" + name;

    // æ¸…å§“åã€é‡æ–°å–å¾—ä¸‹ä¸€è™Ÿ
    document.getElementById("newName").value = "";
    await loadNextId();
  }catch(e){
    console.error(e);
    msg.innerText = "æ–°å¢å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰";
  }
}
window.addEventListener("load", () => {
  const savedId = localStorage.getItem("userId");
  const savedName = localStorage.getItem("userName");
  if(savedId && savedName){
    document.getElementById("userName").innerText = savedName;
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("app").style.display = "block";
  }

  loadNextId(); // âœ… æ–°å¢é€™è¡Œ
});

</script>
</body>
</html>

