<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>é‹¼ç´éŠæˆ²</title>

<style>
  body{
    font-family:"Microsoft JhengHei",sans-serif;
    background:#222;color:#fff;text-align:center;
    font-size:20px;padding-top:20px;
  }
  .box{background:#333;border-radius:10px;padding:20px;margin:15px auto;max-width:760px}
  .row{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
  button,input,select{
    font-size:20px;padding:12px 16px;border-radius:8px;border:none;margin:6px
  }
  input{border:1px solid #666;min-width:200px}
  button{background:#555;color:#fff;cursor:pointer}
  button:hover{filter:brightness(1.05)}
  .btn-connect{background:#007bff}
  .btn-start{background:#28a745;font-size:26px;padding:16px 44px;display:none}
  .status-ok{color:#4cff00;font-weight:bold}
  #gameArea{display:none;margin-top:30px}
  .timer{font-size:46px;color:#00d2ff;font-family:monospace}
  .note-display{font-size:90px;color:yellow;font-weight:bold}
  .test-panel{display:none;background:#444;padding:12px;border-radius:8px;margin-top:12px}
  .hint{color:#bbb;margin-top:8px}
  .small{font-size:16px;color:#aaa}
</style>
</head>

<body>

<!-- âœ… ç™»å…¥ -->
<div id="loginBox" class="box">
  <div class="row">
    <input id="idInput" placeholder="è¼¸å…¥åºŠè™Ÿ" />
    <input id="nameInput" placeholder="ä½æ°‘å§“å" />
    <button id="btnLogin">ç™»å…¥</button>
  </div>
  <p id="loginMsg" class="hint"></p>
</div>

<!-- âœ… æ–°å¢äººå“¡ -->
<div id="addBox" class="box">
  <h3 style="margin:0 0 10px 0;">â• æ–°å¢äººå“¡</h3>
  <div class="row">
    <input id="newId" placeholder="è‡ªå‹•ç·¨è™Ÿ" readonly />
    <input id="newName" placeholder="è¼¸å…¥å§“å" />
    <button id="btnAdd">å„²å­˜</button>
  </div>
  <p id="addMsg" class="hint"></p>
</div>

<!-- âœ… ä¸»ç³»çµ± -->
<div id="app" style="display:none">

  <div class="box">
    <h2 style="margin:0">
      ğŸ‘¤ ä½æ°‘ï¼š<span id="userName">---</span>
      <button id="btnLogout" style="margin-left:10px;">ç™»å‡º</button>
    </h2>
    <p class="small">éŸ³åï¼šDo(è—) / Re(ç´…) / Mi(é»ƒ) / So(ç™½) / Fa(ç¶ )ï¼›ç¡¬é«”æ’åˆ—ï¼šç´…ã€è—ã€é»ƒã€ç™½ã€ç¶ </p>
  </div>

  <div class="box">
    <p>
      LEDï¼š<span id="ledStatus">æœªé€£ç·š</span>
      <button class="btn-connect" id="btnLed">é€£æ¥</button>
    </p>
    <p>
      æŒ‰éˆ•ï¼š<span id="btnStatus">æœªé€£ç·š</span>
      <button class="btn-connect" id="btnBtn">é€£æ¥</button>
    </p>

    <div id="hardwareTest" class="test-panel">
      <div style="margin-bottom:8px;">æ¸¬è©¦ç‡ˆè™Ÿï¼ˆç¡¬é«”é †åºï¼šç´…è—é»ƒç™½ç¶ ï¼‰</div>
      <button id="t1">1 ç´… Re</button>
      <button id="t2">2 è— Do</button>
      <button id="t3">3 é»ƒ Mi</button>
      <button id="t4">4 ç™½ So</button>
      <button id="t5">5 ç¶  Fa</button>
      <button id="t0" style="background:#444;">é—œç‡ˆ</button>
    </div>
  </div>

  <div class="box">
    <div style="margin-bottom:10px;">ğŸµ é¸æ“‡æ­Œæ›²</div>
    <select id="songSelect" style="width:92%;max-width:680px;">
      <!-- æ³¨æ„ï¼šæ­Œè­œç”¨ã€ŒéŸ³åæ•¸å­—ã€ï¼š1=Doã€2=Reã€3=Miã€4=Faã€5=So -->
      <option value="1,1,2,2,3,3,2,1,1,2,2,3,3,2">å°æ˜Ÿæ˜Ÿ(é•·)</option>
      <option value="3,1,2,1,3,3,3,1,1,1,3,4,4,3,1,2,1,3,3,3,3,1,1,3,1,2">ç‘ªè‰æœ‰éš»å°ç¶¿ç¾Š(é•·)</option>
      <option value="2,3,2,3,4,3,2,1,2,3,4,3,2,2,3,2,3,4,3,2,1,2,3,4,3,2,3,4,5,4,3,2">æ‹”è˜¿è””(é•·)</option>
      <option value="2,2,3,4,4,3,2,1,2,3,4,3,2,2,2,3,4,4,3,2,1,2,3,4,3,2,3,4,5,4,3,2,1">å°å…”å­(é•·)</option>
      <option value="2,3,4,4,5,4,3,2,2,3,4,3,2,2,3,4,4,5,4,3,2,2,3,4,3,2,3,4,5,4,3,2">åˆ’å‘€åˆ’å°èˆ¹(é•·)</option>

      <!-- âœ… ä½ è¦æˆ‘åŠ ã€Œæ²’æœ‰çš„ 5 é¦–æ­Œã€(éƒ½åªç”¨ 1~5) -->
      <option value="1,2,3,1,1,2,3,1,3,4,5,3,4,5,5,3,5,5,3,5,1,5,1,1,2,3,1,1,2,3,1">å…©éš»è€è™(é•·)</option>
      <option value="3,3,4,5,5,4,3,2,1,1,2,3,3,2,2,3,3,4,5,5,4,3,2,1,1,2,3,2,1,1">æ­¡æ¨‚é Œ(é•·)</option>
      <option value="5,3,3,4,2,2,1,2,3,4,5,5,5,2,2,2,2,2,3,4,3,3,3,3,4,5,5,3,3,4,2,2,1">å°èœœèœ‚(é•·)</option>
      <option value="1,2,3,4,5,5,4,3,2,1,1,2,3,4,5,5,4,3,2,1,1,2,3,2,1,1">éŸ³éšä¸Šä¸‹(é•·)</option>
      <option value="1,3,5,3,1,3,5,3,2,4,5,4,2,4,5,4,1,3,5,3,2,4,5,4,2,4,5,4">åˆ†è§£å’Œå¼¦(é•·)</option>
    </select>
    <br><br>
    <button id="startBtn" class="btn-start">é–‹å§‹éŠæˆ²</button>
    <p id="warnMsg" class="hint"></p>
  </div>

  <div id="gameArea" class="box">
    <div class="timer"><span id="timeDisplay">0.00</span> ç§’</div>
    <div class="note-display" id="currentNote">-</div>
    <p id="logMsg" class="hint">ç­‰å¾…é–‹å§‹â€¦</p>
    <button id="btnStop" style="background:#dc3545">çµæŸ</button>
  </div>

  <div class="box">
    <div class="small">é™¤éŒ¯ï¼š<span id="debugText">ç„¡</span></div>
  </div>
</div>

<script>
/* ========= ä¸€å¾‹ç”¨ getElementByIdï¼ˆé¿å…ã€Œæ²’è·‘å‡ºä¾†ã€ï¼‰ ========= */
const $ = (id)=>document.getElementById(id);

const el = {
  loginBox: $("loginBox"),
  addBox: $("addBox"),
  app: $("app"),
  idInput: $("idInput"),
  nameInput: $("nameInput"),
  loginMsg: $("loginMsg"),
  newId: $("newId"),
  newName: $("newName"),
  addMsg: $("addMsg"),
  userName: $("userName"),
  ledStatus: $("ledStatus"),
  btnStatus: $("btnStatus"),
  hardwareTest: $("hardwareTest"),
  songSelect: $("songSelect"),
  startBtn: $("startBtn"),
  warnMsg: $("warnMsg"),
  gameArea: $("gameArea"),
  timeDisplay: $("timeDisplay"),
  currentNote: $("currentNote"),
  logMsg: $("logMsg"),
  debugText: $("debugText"),

  btnLogin: $("btnLogin"),
  btnAdd: $("btnAdd"),
  btnLogout: $("btnLogout"),
  btnLed: $("btnLed"),
  btnBtn: $("btnBtn"),
  btnStop: $("btnStop"),

  t0: $("t0"), t1: $("t1"), t2: $("t2"), t3: $("t3"), t4: $("t4"), t5: $("t5"),
};

/* ========= API è·¯å¾‘ï¼ˆç…§ä½ ä¹‹å‰ç”¨çš„ï¼‰ ========= */
const API = {
  loginById: (id)=>`/test/api/login.php?id=${encodeURIComponent(id)}`,
  findByName: (name)=>`/test/api/find_player.php?name=${encodeURIComponent(name)}`,
  nextId: ()=>`/test/api/next_player_id.php`,
  addPlayer: ()=>`/test/api/add_player.php`,
  saveScore: ()=>`/test/api/save_score.php`,
};

function log(msg){
  el.debugText.textContent = msg;
  console.log(msg);
}

/* ========= é¡¯ç¤º/éš±è— ========= */
function showLogin(){
  el.app.style.display = "none";
  el.loginBox.style.display = "block";
  el.addBox.style.display = "block";
}
function showApp(){
  el.loginBox.style.display = "none";
  el.addBox.style.display = "none";
  el.app.style.display = "block";
}

/* ========= ç™»å…¥ / æ–°å¢ ========= */
async function fetchUserById(id){
  const res = await fetch(API.loginById(id), {cache:"no-store"});
  if(!res.ok) return null;
  const data = await res.json();
  return data && data.id ? data : null;
}
async function fetchUserByName(name){
  const res = await fetch(API.findByName(name), {cache:"no-store"});
  if(!res.ok) return null;
  const data = await res.json();
  return data && data.id ? data : null;
}

async function login(){
  const id = el.idInput.value.trim();
  const name = el.nameInput.value.trim();
  if(!id && !name){ el.loginMsg.textContent = "è«‹è¼¸å…¥åºŠè™Ÿæˆ–å§“å"; return; }

  el.loginMsg.textContent = "æŸ¥è©¢ä¸­...";
  try{
    let user = null;
    if(id) user = await fetchUserById(id);
    else user = await fetchUserByName(name);

    if(!user){ el.loginMsg.textContent = "æ‰¾ä¸åˆ°æ­¤ä½æ°‘"; return; }

    localStorage.setItem("userId", user.id);
    localStorage.setItem("userName", user.name);

    el.idInput.value = user.id;
    el.nameInput.value = user.name;
    el.userName.textContent = `${user.id}ï½œ${user.name}`;

    el.loginMsg.textContent = "";
    showApp();
  }catch(err){
    console.error(err);
    el.loginMsg.textContent = "ç™»å…¥å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰";
  }
}

async function loadNextId(){
  el.addMsg.textContent = "";
  try{
    const res = await fetch(API.nextId(), {cache:"no-store"});
    const data = await res.json();
    el.newId.value = data.next_id || "";
  }catch(err){
    console.error(err);
    el.addMsg.textContent = "å–å¾—ä¸‹ä¸€è™Ÿå¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰";
  }
}

async function addPlayer(){
  const id = el.newId.value.trim();
  const name = el.newName.value.trim();
  if(!id){ el.addMsg.textContent = "æ²’æœ‰è‡ªå‹•ç·¨è™Ÿ"; return; }
  if(!name){ el.addMsg.textContent = "è«‹è¼¸å…¥å§“å"; return; }

  el.addMsg.textContent = "å„²å­˜ä¸­...";
  try{
    const res = await fetch(API.addPlayer(), {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({id, name})
    });
    const text = await res.text();
    if(!res.ok){ el.addMsg.textContent = "æ–°å¢å¤±æ•—ï¼š" + text; return; }

    el.addMsg.textContent = `âœ… æ–°å¢æˆåŠŸï¼ˆ${id}ï½œ${name}ï¼‰`;
    el.idInput.value = id;
    el.nameInput.value = name;
    el.newName.value = "";
    await loadNextId();
  }catch(err){
    console.error(err);
    el.addMsg.textContent = "æ–°å¢å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰";
  }
}

function logout(){
  try{ stopGame(); }catch(e){}
  localStorage.removeItem("userId");
  localStorage.removeItem("userName");
  location.reload();
}

/* ========= è‡ªå‹•å¸¶å…¥ï¼ˆåºŠè™Ÿ/å§“åï¼‰ ========= */
function bindAutoFill(){
  let t1=null, t2=null;

  el.idInput.addEventListener("input", ()=>{
    clearTimeout(t1);
    t1 = setTimeout(async ()=>{
      const id = el.idInput.value.trim();
      el.loginMsg.textContent = "";
      if(!id) return;
      const user = await fetchUserById(id);
      if(user) el.nameInput.value = user.name || "";
      else el.loginMsg.textContent = "æ‰¾ä¸åˆ°æ­¤åºŠè™Ÿ";
    }, 250);
  });

  el.nameInput.addEventListener("input", ()=>{
    clearTimeout(t2);
    t2 = setTimeout(async ()=>{
      const name = el.nameInput.value.trim();
      el.loginMsg.textContent = "";
      if(!name){ el.idInput.value=""; return; }
      const user = await fetchUserByName(name);
      if(user){
        el.idInput.value = user.id || "";
        el.nameInput.value = user.name || name;
      }else{
        el.idInput.value = "";
        el.loginMsg.textContent = "æ‰¾ä¸åˆ°æ­¤å§“å";
      }
    }, 250);
  });
}

/* ========= BLE / éŠæˆ² ========= */
const LED_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const LED_CHAR = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
const BTN_SERVICE_UUID = "1234c201-1fb5-459e-8fcc-c5c9c331914b";
const BTN_NOTIFY_UUID  = "5678483e-36e1-4688-b7f5-ea07361b26a8";
const BTN_TARGET_UUID  = "3456483e-36e1-4688-b7f5-ea07361b26a8";

let ledChar=null, targetChar=null;
let song=[], idx=0, isPlaying=false, timerInt=null, startTime=0;

/*
éŸ³åï¼ˆæ­Œè­œç”¨ï¼‰ï¼š
1=Do(è—) 2=Re(ç´…) 3=Mi(é»ƒ) 4=Fa(ç¶ ) 5=So(ç™½)

ç¡¬é«”éµä½æ’åˆ—ï¼ˆä½ ç¾å ´ï¼‰ï¼š
1=ç´… 2=è— 3=é»ƒ 4=ç™½ 5=ç¶ 

æ‰€ä»¥ éŸ³å -> ç¡¬é«”ï¼š
Do(1)->2
Re(2)->1
Mi(3)->3
Fa(4)->5
So(5)->4
*/
const NOTE_TO_HW = {1:2,2:1,3:3,4:5,5:4};
const NOTE_NAME  = {1:"Do",2:"Re",3:"Mi",4:"Fa",5:"So"};

function mapToHw(n){ return NOTE_TO_HW[n] ?? n; }

async function connectLed(){
  try{
    const dev = await navigator.bluetooth.requestDevice({
      filters:[{name:"ESP32_LED_Control"}],
      optionalServices:[LED_UUID]
    });
    const srv = await dev.gatt.connect();
    const svc = await srv.getPrimaryService(LED_UUID);
    ledChar = await svc.getCharacteristic(LED_CHAR);

    el.ledStatus.textContent="å·²é€£ç·š âœ…";
    el.ledStatus.className="status-ok";
    ready();
  }catch(e){
    alert("LED é€£ç·šå¤±æ•—ï¼š" + e);
  }
}

async function connectBtn(){
  try{
    const dev = await navigator.bluetooth.requestDevice({
      filters:[{name:"ESP32_Button_Input"}],
      optionalServices:[BTN_SERVICE_UUID]
    });
    const srv = await dev.gatt.connect();
    const svc = await srv.getPrimaryService(BTN_SERVICE_UUID);

    const notify = await svc.getCharacteristic(BTN_NOTIFY_UUID);
    targetChar  = await svc.getCharacteristic(BTN_TARGET_UUID);

    await notify.startNotifications();
    notify.addEventListener("characteristicvaluechanged", onBtnPress);

    el.btnStatus.textContent="å·²é€£ç·š âœ…";
    el.btnStatus.className="status-ok";
    ready();
  }catch(e){
    alert("æŒ‰éˆ•é€£ç·šå¤±æ•—ï¼š" + e);
  }
}

function ready(){
  el.hardwareTest.style.display = "block";
  if(ledChar && targetChar){
    el.startBtn.style.display = "inline-block";
    el.warnMsg.textContent = "";
  }else{
    el.warnMsg.textContent = "è«‹å…ˆå®Œæˆ LED èˆ‡ æŒ‰éˆ• å…©é‚Šé€£ç·šï¼Œæ‰å¯é–‹å§‹éŠæˆ²";
  }
}

function testLed(n){
  if(!ledChar){ alert("LED å°šæœªé€£ç·š"); return; }
  ledChar.writeValue(new TextEncoder().encode(String(n)));
}

function startGame(){
  if(!(ledChar && targetChar)){
    el.warnMsg.textContent = "âš ï¸ è«‹å…ˆé€£ç·š LED èˆ‡æŒ‰éˆ•æ¿";
    return;
  }

  song = el.songSelect.value.split(",").map(s=>Number(String(s).trim()))
    .filter(n=>Number.isFinite(n) && n>=1 && n<=5);

  if(song.length===0){ alert("æ­Œæ›²è³‡æ–™éŒ¯èª¤"); return; }

  idx=0; isPlaying=true;
  el.gameArea.style.display="block";
  el.logMsg.textContent="é–‹å§‹ï¼";

  startTime=Date.now();
  if(timerInt) clearInterval(timerInt);
  timerInt=setInterval(()=>{
    el.timeDisplay.textContent=((Date.now()-startTime)/1000).toFixed(2);
  },30);

  playNote();
}

function playNote(){
  if(!isPlaying) return;
  if(idx>=song.length){ finishGame(); return; }

  const note = song[idx];        // 1~5 éŸ³å
  const hw   = mapToHw(note);    // 1~5 ç¡¬é«”éµä½

  // é¡¯ç¤ºï¼šç”¨éŸ³åæ›´ç›´è¦º
  el.currentNote.textContent = `${note}\n${NOTE_NAME[note] || ""}`.trim();
  el.logMsg.textContent = `ç›®æ¨™ï¼š${NOTE_NAME[note]}ï¼ˆæŒ‰ä¸‹å°æ‡‰æŒ‰éˆ•ï¼‰`;

  // å…ˆäº®ç‡ˆ
  ledChar.writeValue(new TextEncoder().encode(String(hw)));

  // å†é€è²éŸ³ç›®æ¨™ï¼ˆå»¶é²ï¼Œé¿å…ç¬¬ä¸€é¡†è¢«åƒæ‰ï¼‰
  setTimeout(()=>{
    if(targetChar) targetChar.writeValue(new TextEncoder().encode(String(hw)));
  }, 60);
}

function onBtnPress(e){
  if(!isPlaying) return;
  const pressed = parseInt(new TextDecoder().decode(e.target.value), 10);

  const note = song[idx];
  const hw   = mapToHw(note);

  if(pressed === hw){
    idx++;
    setTimeout(playNote, 50);
  }else{
    el.logMsg.textContent = "âŒ æŒ‰éŒ¯äº†ï¼ˆå†è©¦ä¸€æ¬¡ï¼‰";
  }
}

async function saveScore(seconds){
  const playerId = localStorage.getItem("userId");
  const playerName = localStorage.getItem("userName");
  const songName = el.songSelect.options[el.songSelect.selectedIndex]?.textContent || "unknown";
  if(!playerId || !playerName) return;

  try{
    const res = await fetch(API.saveScore(), {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        player_id: playerId,
        player_name: playerName,
        song_name: songName,
        seconds: Number(seconds)
      })
    });
    const t = await res.text();
    if(!res.ok) log("å­˜åˆ†æ•¸å¤±æ•—: " + t);
    else log("å·²å­˜åˆ†æ•¸: " + t);
  }catch(err){
    console.error(err);
    log("å­˜åˆ†æ•¸å¤±æ•—ï¼ˆç¶²è·¯/APIï¼‰");
  }
}

async function finishGame(){
  isPlaying=false;
  if(timerInt){ clearInterval(timerInt); timerInt=null; }
  try{ ledChar.writeValue(new TextEncoder().encode("0")); }catch(e){}
  try{ targetChar.writeValue(new TextEncoder().encode("0")); }catch(e){}

  const seconds = parseFloat(el.timeDisplay.textContent) || 0;
  await saveScore(seconds);

  alert("å®Œæˆï¼ç¸½æ™‚é–“ï¼š" + seconds.toFixed(2) + " ç§’");
  stopGame();
}

function stopGame(){
  isPlaying=false;
  if(timerInt){ clearInterval(timerInt); timerInt=null; }
  el.gameArea.style.display="none";
  try{ ledChar?.writeValue(new TextEncoder().encode("0")); }catch(e){}
  try{ targetChar?.writeValue(new TextEncoder().encode("0")); }catch(e){}
}

/* ========= åˆå§‹åŒ– ========= */
document.addEventListener("DOMContentLoaded", async ()=>{
  // æŒ‰éˆ•ç¶å®šï¼ˆé¿å… inline onclick åœ¨æŸäº›ç’°å¢ƒå¤±æ•ˆï¼‰
  el.btnLogin.addEventListener("click", login);
  el.btnAdd.addEventListener("click", addPlayer);
  el.btnLogout.addEventListener("click", logout);
  el.btnLed.addEventListener("click", connectLed);
  el.btnBtn.addEventListener("click", connectBtn);
  el.startBtn.addEventListener("click", startGame);
  el.btnStop.addEventListener("click", stopGame);

  el.t0.addEventListener("click", ()=>testLed(0));
  el.t1.addEventListener("click", ()=>testLed(1));
  el.t2.addEventListener("click", ()=>testLed(2));
  el.t3.addEventListener("click", ()=>testLed(3));
  el.t4.addEventListener("click", ()=>testLed(4));
  el.t5.addEventListener("click", ()=>testLed(5));

  bindAutoFill();
  await loadNextId();

  const savedId = localStorage.getItem("userId");
  const savedName = localStorage.getItem("userName");
  if(savedId && savedName){
    el.userName.textContent = `${savedId}ï½œ${savedName}`;
    showApp();
  }else{
    showLogin();
  }
});
</script>

</body>
</html>
