<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>é‹¼ç´éŠæˆ²</title>

<style>
  body{
    font-family:"Microsoft JhengHei",sans-serif;
    background:#222;color:#fff;text-align:center;
    font-size:20px;padding-top:20px;margin:0;
  }
  .box{
    background:#333;border-radius:10px;padding:20px;margin:15px auto;max-width:720px;
    border:1px solid #555;
  }
  button,input,select{
    font-size:20px;padding:12px 16px;border-radius:8px;border:none;margin:6px;
  }
  input{border:1px solid #666; width:220px; background:#fff;}
  select{border:1px solid #666; width:92%; max-width:620px;}
  button{background:#555;color:#fff;cursor:pointer}
  button:hover{filter:brightness(1.05)}
  .btn-connect{background:#007bff}
  .btn-start{background:#28a745;font-size:26px;padding:16px 44px;display:none}
  .btn-stop{background:#dc3545}
  .status-ok{color:#4cff00;font-weight:bold}
  .test-panel{display:none;background:#444;padding:12px;border-radius:8px;border:1px dashed #777;margin-top:12px}
  #gameArea{display:none;margin-top:20px}
  .timer{font-size:46px;color:#00d2ff;font-family:monospace}
  .note-display{font-size:90px;color:yellow;font-weight:bold;margin:10px 0}
  .hint{color:#aaa;margin-top:6px}
  .row{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
  .small{font-size:16px;color:#bbb}
  .debug{font-size:14px;color:#aaa;margin-top:10px;word-break:break-all}
</style>
</head>

<body>

<!-- ç™»å…¥ -->
<div id="loginBox" class="box">
  <div class="row">
    <input id="idInput" placeholder="è¼¸å…¥åºŠè™Ÿ" />
    <input id="nameInput" placeholder="ä½æ°‘å§“å" />
    <button onclick="login()">ç™»å…¥</button>
  </div>
  <p id="loginMsg" class="hint"></p>

  <hr style="border:0;border-top:1px solid #555;margin:18px 0;">

  <h3 style="margin:0 0 10px 0;">â• æ–°å¢äººå“¡</h3>
  <div class="row">
    <input id="newId" placeholder="è‡ªå‹•ç·¨è™Ÿ" readonly />
    <input id="newName" placeholder="è¼¸å…¥å§“å" />
    <button onclick="addPlayer()">å„²å­˜</button>
  </div>
  <p id="addMsg" class="hint"></p>
  <p class="small">æç¤ºï¼šå¯ç›´æ¥æ‰“å§“åç™»å…¥ï¼›æˆ–æ‰“åºŠè™Ÿæœƒè‡ªå‹•å¸¶å‡ºå§“åï¼ˆå¦‚æœè³‡æ–™åº«æœ‰ï¼‰ã€‚</p>
</div>

<!-- ä¸»ç³»çµ± -->
<div id="app" style="display:none;">
  <div class="box">
    <h2 style="margin:0;">
      ğŸ‘¤ ä½æ°‘ï¼š<span id="userName">---</span>
      <button onclick="logout()">ç™»å‡º</button>
    </h2>
    <p class="small" style="margin:10px 0 0 0;">
      
    </p>
  </div>

  <div id="mainPage">
    <div class="box">
      <h3 style="margin:0 0 10px 0;">1. è£ç½®é€£ç·š</h3>
      <div class="row">
        <div>
          LEDï¼š<span id="ledStatus">æœªé€£ç·š âŒ</span>
          <button class="btn-connect" onclick="connectLed()">é€£æ¥</button>
        </div>
        <div>
          æŒ‰éˆ•ï¼š<span id="btnStatus">æœªé€£ç·š âŒ</span>
          <button class="btn-connect" onclick="connectBtn()">é€£æ¥</button>
        </div>
      </div>

      <div id="hardwareTest" class="test-panel">
        <h4 style="margin:0 0 10px 0;">ğŸ”§ æ¸¬è©¦ç‡ˆè™Ÿï¼ˆå¯¦é«”é †åºï¼‰</h4>
        <div class="row">
          <button onclick="testLed(1)">1 ç´… Re</button>
          <button onclick="testLed(2)">2 è— Do</button>
          <button onclick="testLed(3)">3 é»ƒ Mi</button>
          <button onclick="testLed(4)">4 ç™½ So</button>
          <button onclick="testLed(5)">5 ç¶  Fa</button>

        </div>
        <p class="hint">æœ€å¾ŒæŒ‰ä¸‹ï¼š<span id="lastPressed" style="color:yellow;font-weight:bold;">-</span></p>
      </div>
    </div>

    <div class="box">
      <h3 style="margin:0 0 10px 0;">2. é¸æ“‡æ­Œæ›²</h3>

      <!-- é‡è¦ï¼šé€™è£¡çš„ value å·²ç¶“æ˜¯ã€Œå¯¦é«”é †åºæ•¸å­—ã€(1~5) -->
      <select id="songSelect">
        <!-- ä½ åŸæœ¬å·²ç¶“ä¿®éçš„å¹¾é¦–ï¼ˆä¿ç•™ï¼‰ -->
        <option value="3,1,2,1,3,3,3,1,1,1,3,4,4,3,1,2,1,3,3,3,3,1,1,3,1,2">ç‘ªè‰æœ‰éš»å°ç¶¿ç¾Š</option>
        <option value="2,2,4,4,5,5,4,3,3,1,1,2,4,4,3,3,1,4,4,3,3,1,2,2,4,4,5,5,4,3,3,1,1,2">å°æ˜Ÿæ˜Ÿ</option>
        <option value="3,3,5,3,4,5,3,3,5,3,2,3,3,4,5,3,1,2,5,5,3,2,1,2">ç”Ÿæ—¥å¿«æ¨‚</option>
        <option value="2,1,3,2,2,1,3,2,3,5,4,3,5,4,4,3,4,4,3,4,2,4,2">å…©éš»è€è™</option>
        <option value="4,3,3,5,1,1,2,1,3,5,4,4,4,1,1,1,1,1,3,5,3,3,3,3,5,4,4,3,3,5,1,1,2">å°èœœèœ‚</option>
        <option value="3,3,5,4,4,5,3,1,2,2,1,3,3,1,1,3,3,5,4,4,5,3,1,2,2,1,3,1,2,2">æ­¡æ¨‚é Œ</option>
        <option value="2,1,3,5,4,4,5,3,1,2,2,1,3,5,4,4,5,3,1,2">éŸ³éšä¸Šä¸‹</option>
        <option value="2,3,4,3,2,3,4,3,1,5,4,5,1,5,4,5,2,3,4,3">åˆ†è§£å’Œå¼¦</option>

        <!-- ä½ æ–°å¢çš„ -->
        <option value="2,2,3,3,4,3,2,1,2,3,4,4,3">åˆ’é¾èˆŸ</option>
        <option value="2,3,2,3,4,3,2,1,2,3,4,3,2,2,3,2,3,4,3,2,1,2,3,4,3,2,3,4,5,4,3,2">æ‹”è˜¿è””</option>
        <option value="2,2,3,4,4,3,2,1,2,3,4,3,2,2,2,3,4,4,3,2,1,2,3,4,3,2,3,4,5,4,3,2,1">å°å…”å­</option>
        <option value="2,3,4,4,5,4,3,2,2,3,4,3,2,2,3,4,4,5,4,3,2,2,3,4,3,2,3,4,5,4,3,2">åˆ’å‘€åˆ’å°èˆ¹</option>

        <!-- å†è£œ 1 é¦–è¼ƒé•·ï¼ˆåªç”¨ 1~5ï¼‰ -->
        <option value="2,3,4,5,4,3,2,1,2,2,3,3,4,4,5,4,3,2,1,2,3,2,1,1,2,3,4,5,5,4,3,2,2,1">å°æ­¥èˆæ›²(ç°¡åŒ–ç‰ˆ)</option>
      </select>

      <div class="hint">æ‰€æœ‰æ­Œæ›²åªå…è¨± 1~5ï¼ˆä¾ä½ çš„å¯¦é«”é¡è‰²/éŸ³åå®šç¾©ï¼‰</div>

      <br>
      <button id="startBtn" class="btn-start" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
    </div>
  </div>

  <div id="gameArea" class="box">
    <div class="timer"><span id="timeDisplay">0.00</span> ç§’</div>
    <div class="note-display" id="currentNote">-</div>
    <p id="logMsg" class="hint">ç­‰å¾…é–‹å§‹â€¦</p>
    <button class="btn-stop" onclick="stopGame()">çµæŸ</button>
    <div class="debug">é™¤éŒ¯ï¼š<span id="debugText">ç„¡</span></div>
  </div>
</div>

<script>
/* ================== ä½ çš„ API è·¯å¾‘ï¼ˆä¿ç•™ï¼‰ ================== */
async function fetchUserById(id){
  const res = await fetch(`/test/api/login.php?id=${encodeURIComponent(id)}`, { cache:"no-store" });
  if(!res.ok) return null;
  const data = await res.json();
  return data && data.id ? data : null;
}
async function fetchUserByName(name){
  const res = await fetch(`/test/api/find_player.php?name=${encodeURIComponent(name)}`, { cache:"no-store" });
  if(!res.ok) return null;
  const data = await res.json();
  return data && data.id ? data : null;
}
async function loadNextId(){
  addMsg.innerText = "";
  try{
    const res = await fetch(`/test/api/next_player_id.php`, { cache:"no-store" });
    const data = await res.json();
    newId.value = data.next_id || "";
    newId.readOnly = true;
  }catch(e){
    console.error(e);
    addMsg.innerText = "å–å¾—ä¸‹ä¸€è™Ÿå¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰";
  }
}
async function addPlayer(){
  const id = newId.value.trim();
  const name = newName.value.trim();
  if(!id){ addMsg.innerText = "æ²’æœ‰è‡ªå‹•ç·¨è™Ÿ"; return; }
  if(!name){ addMsg.innerText = "è«‹è¼¸å…¥å§“å"; return; }

  addMsg.innerText = "å„²å­˜ä¸­...";
  try{
    const res = await fetch(`/test/api/add_player.php`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ id, name })
    });
    const text = await res.text();
    if(!res.ok){ addMsg.innerText = "æ–°å¢å¤±æ•—ï¼š" + text; return; }

    addMsg.innerText = `âœ… æ–°å¢æˆåŠŸï¼ˆ${id}ï½œ${name}ï¼‰`;
    idInput.value = id;
    nameInput.value = name;
    newName.value = "";
    await loadNextId();
  }catch(e){
    console.error(e);
    addMsg.innerText = "æ–°å¢å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰";
  }
}
async function saveScore(seconds){
  const playerId = localStorage.getItem("userId");
  const playerName = localStorage.getItem("userName");
  const songName = document.querySelector("#songSelect option:checked")?.textContent || "unknown";
  if(!playerId || !playerName){ log("âš ï¸ æœªç™»å…¥ï¼Œç•¥éå­˜åˆ†æ•¸"); return; }

  const res = await fetch(`/test/api/save_score.php`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      player_id: playerId,
      player_name: playerName,
      song_name: songName,
      seconds: Number(seconds)
    })
  });
  const t = await res.text();
  if(!res.ok) log("âŒ å­˜åˆ†æ•¸å¤±æ•—: " + t);
  else log("âœ… å·²å­˜åˆ†æ•¸: " + t);
}

/* ================== ç™»å…¥/ç™»å‡º/è‡ªå‹•å¸¶å…¥ ================== */
function showLogin(){
  loginBox.style.display = "block";
  app.style.display = "none";
}
function showApp(){
  loginBox.style.display = "none";
  app.style.display = "block";
  mainPage.style.display = "block";
  gameArea.style.display = "none";
}
function logout(){
  try{ stopGame(); }catch(e){}
  localStorage.removeItem("userId");
  localStorage.removeItem("userName");
  idInput.value = "";
  nameInput.value = "";
  userName.innerText = "---";
  showLogin();
}
async function login(){
  const id = idInput.value.trim();
  const name = nameInput.value.trim();
  if(!id && !name){ loginMsg.innerText = "è«‹è¼¸å…¥åºŠè™Ÿæˆ–å§“å"; return; }
  loginMsg.innerText = "æŸ¥è©¢ä¸­...";

  try{
    let user = null;
    if(id) user = await fetchUserById(id);
    else user = await fetchUserByName(name);

    if(!user){ loginMsg.innerText = "æ‰¾ä¸åˆ°æ­¤ä½æ°‘"; return; }

    localStorage.setItem("userId", user.id);
    localStorage.setItem("userName", user.name);

    idInput.value = user.id;
    nameInput.value = user.name;
    userName.innerText = `${user.id}ï½œ${user.name}`;

    loginMsg.innerText = "";
    showApp();
  }catch(e){
    console.error(e);
    loginMsg.innerText = "ç™»å…¥å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰";
  }
}
function bindIdAutoFill(){
  let timer=null;
  idInput.addEventListener("input", ()=>{
    clearTimeout(timer);
    timer=setTimeout(async ()=>{
      const id = idInput.value.trim();
      nameInput.value = "";
      loginMsg.innerText = "";
      if(!id) return;
      const user = await fetchUserById(id);
      if(user) nameInput.value = user.name || "";
      else loginMsg.innerText = "æ‰¾ä¸åˆ°æ­¤åºŠè™Ÿ";
    }, 250);
  });
}
function bindNameAutoFill(){
  let timer=null;
  nameInput.addEventListener("input", ()=>{
    clearTimeout(timer);
    const name = nameInput.value.trim();
    loginMsg.innerText = "";
    if(!name){ idInput.value=""; return; }

    timer=setTimeout(async ()=>{
      try{
        const user = await fetchUserByName(name);
        if(user){
          idInput.value = user.id || "";
          nameInput.value = user.name || name;
        }else{
          idInput.value = "";
          loginMsg.innerText = "æ‰¾ä¸åˆ°æ­¤å§“å";
        }
      }catch(e){
        console.error(e);
        loginMsg.innerText = "æŸ¥è©¢å¤±æ•—ï¼ˆè«‹çœ‹ Consoleï¼‰";
      }
    }, 250);
  });
}

/* ================== BLEï¼ˆå¯¦é«”é †åºçµ±ä¸€ï¼Œä¸å†è½‰æ›ï¼‰ ================== */
const LED_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
const LED_CHAR = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

const BTN_SERVICE_UUID = "1234c201-1fb5-459e-8fcc-c5c9c331914b";
const BTN_NOTIFY_UUID  = "5678483e-36e1-4688-b7f5-ea07361b26a8";
const BTN_TARGET_UUID  = "3456483e-36e1-4688-b7f5-ea07361b26a8";

let ledChar=null, targetChar=null;
let isPlaying=false, song=[], index=0, timerInt=null, startTime=0;

function log(msg){
  debugText.innerText = msg;
  console.log(msg);
}

async function connectLed(){
  try{
    const dev = await navigator.bluetooth.requestDevice({
      filters:[{name:"ESP32_LED_Control"}],
      optionalServices:[LED_UUID]
    });
    const srv = await dev.gatt.connect();
    const svc = await srv.getPrimaryService(LED_UUID);
    ledChar = await svc.getCharacteristic(LED_CHAR);

    ledStatus.innerText="å·²é€£ç·š âœ…";
    ledStatus.className="status-ok";
    readyCheck();
  }catch(e){
    alert("LEDé€£ç·šå¤±æ•—: " + e);
  }
}

async function connectBtn(){
  try{
    const dev = await navigator.bluetooth.requestDevice({
      filters:[{name:"ESP32_Button_Input"}],
      optionalServices:[BTN_SERVICE_UUID]
    });
    const srv = await dev.gatt.connect();
    const svc = await srv.getPrimaryService(BTN_SERVICE_UUID);

    const notify = await svc.getCharacteristic(BTN_NOTIFY_UUID);
    targetChar = await svc.getCharacteristic(BTN_TARGET_UUID);

    await notify.startNotifications();
    notify.addEventListener("characteristicvaluechanged", onBtnPress);

    btnStatus.innerText="å·²é€£ç·š âœ…";
    btnStatus.className="status-ok";
    readyCheck();
  }catch(e){
    alert("æŒ‰éˆ•é€£ç·šå¤±æ•—: " + e);
  }
}

function readyCheck(){
  hardwareTest.style.display = "block";
  const btnOk = btnStatus.className.includes("status-ok");
  if(ledChar && btnOk) startBtn.style.display="inline-block";
}

function testLed(sem){
  if(!ledChar){ alert("LEDå°šæœªé€£ç·š"); return; }
  const hw = toHw(sem);
  ledChar.writeValue(new TextEncoder().encode(String(hw)));
}


/* ================== éŠæˆ² ================== */
function parseSong(){
  return songSelect.value
    .split(",")
    .map(s=>Number(String(s).trim()))
    .filter(n=>Number.isFinite(n) && n>=1 && n<=5);
}

async function startGame(){
  if(!ledChar || !targetChar){
    alert("è«‹å…ˆé€£æ¥ LED èˆ‡ æŒ‰éˆ•æ¿");
    return;
  }

  song = parseSong();
  if(song.length===0){
    alert("æ­Œæ›²è³‡æ–™éŒ¯èª¤ï¼ˆå¿…é ˆæ˜¯ 1~5ï¼‰");
    return;
  }

  // é€²å…¥éŠæˆ²ç•«é¢
  mainPage.style.display="none";
  gameArea.style.display="block";

  // é–‹å±€ï¼šå…ˆæ¸…æ‰ targetï¼ˆé¿å…ç¬¬ä¸€é¡†è¢«åƒæ‰ï¼‰
  try{
    await targetChar.writeValue(new TextEncoder().encode("0"));
  }catch(e){}

  index=0;
  isPlaying=true;
  logMsg.innerText="é–‹å§‹ï¼";

  startTime=Date.now();
  timerInt=setInterval(()=>{
    timeDisplay.innerText=((Date.now()-startTime)/1000).toFixed(2);
  },30);

  // ç¨å¾®ç­‰ä¸€ä¸‹å†å‡ºç¬¬ä¸€é¡†ï¼ˆæ›´ç©©ï¼‰
  setTimeout(playNote, 120);
}

function playNote(){
  if(!isPlaying) return;

  if(index >= song.length){
    finishGame();
    return;
  }

  const sem = song[index];      // æ­Œæ›²è£¡çš„å€¼ï¼š1~5ï¼ˆä½ çš„èªæ„ï¼šç´…è—é»ƒç™½ç¶ ï¼‰
  const hw  = toHw(sem);        // è½‰æˆç¡¬é«”ç¢¼

  currentNote.innerText = sem;  // ç•«é¢é¡¯ç¤ºèªæ„å€¼ï¼ˆä¸æœƒäº‚ï¼‰
  logMsg.innerText = `ç›®æ¨™ï¼š${sem}`;

  // äº®ç‡ˆï¼šé€ç¡¬é«”ç¢¼
  if(ledChar) ledChar.writeValue(new TextEncoder().encode(String(hw)));

  // è²éŸ³ç›®æ¨™ï¼šä¹Ÿé€ç¡¬é«”ç¢¼ï¼ˆå»¶é²é¿å…ç¬¬ä¸€é¡†è¢«åƒï¼‰
  if(targetChar){
    setTimeout(()=>{
      targetChar.writeValue(new TextEncoder().encode(String(hw)));
    }, 60);
  }
}


function onBtnPress(e){
  if(!isPlaying) return;

  const pressed = parseInt(new TextDecoder().decode(e.target.value), 10);
  lastPressed.innerText = isNaN(pressed) ? "-" : pressed;

  const sem = song[index];
  const hw  = toHw(sem);

  if(pressed === hw){
    index++;
    setTimeout(playNote, 60);
  }else{
    logMsg.innerText = "âŒ æŒ‰éŒ¯äº†ï¼";
  }
}

async function finishGame(){
  if(timerInt){ clearInterval(timerInt); timerInt=null; }
  isPlaying=false;

  // é—œç‡ˆã€é—œè²éŸ³
  try{ ledChar.writeValue(new TextEncoder().encode("0")); }catch(e){}
  try{ targetChar.writeValue(new TextEncoder().encode("0")); }catch(e){}

  const seconds = parseFloat(timeDisplay.innerText) || 0;
  await saveScore(seconds);

  alert("å®Œæˆï¼æ™‚é–“ï¼š" + seconds.toFixed(2) + " ç§’");
  stopGame();
}

function stopGame(){
  if(timerInt){ clearInterval(timerInt); timerInt=null; }
  isPlaying=false;

  // é—œç‡ˆã€é—œè²éŸ³
  try{ if(ledChar) ledChar.writeValue(new TextEncoder().encode("0")); }catch(e){}
  try{ if(targetChar) targetChar.writeValue(new TextEncoder().encode("0")); }catch(e){}

  gameArea.style.display="none";
  mainPage.style.display="block";
  logMsg.innerText="ç­‰å¾…é–‹å§‹â€¦";
  currentNote.innerText="-";
  timeDisplay.innerText="0.00";
  log("å·²åœæ­¢");
}

/* ================== åˆå§‹åŒ– ================== */
window.addEventListener("load", async ()=>{
  bindIdAutoFill();
  bindNameAutoFill();
  await loadNextId();

  const savedId = localStorage.getItem("userId");
  const savedName = localStorage.getItem("userName");
  if(savedId && savedName){
    userName.innerText = `${savedId}ï½œ${savedName}`;
    showApp();
  }else{
    showLogin();
  }
});
</script>

</body>
</html>
