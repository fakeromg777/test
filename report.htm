<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å­¸ç¿’æˆæ•ˆè¿½è¹¤</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: 'Microsoft JhengHei', sans-serif; text-align:center; background:#222; color:white; padding-top:20px; }
    .box { border:1px solid #555; padding:22px; margin:15px auto; max-width:980px; border-radius:12px; background:#333; }
    button { padding:10px 18px; font-size:16px; cursor:pointer; border-radius:6px; border:none; margin:5px; background:#555; color:#fff; }
    button:hover { filter:brightness(1.05); }
    .row { display:flex; gap:14px; justify-content:center; align-items:center; flex-wrap:wrap; margin-top:12px; }
    label { color:#ddd; }
    input, select { padding:10px; font-size:16px; border-radius:6px; border:1px solid #666; background:#fff; color:#000; }
    .hint { margin-top:10px; color:#aaa; font-size:14px; }
    .topbar { display:flex; justify-content:center; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:6px; }
    .who { color:#ffcc66; font-weight:bold; }
  </style>
</head>

<body>

<div class="box">
  <h2 style="margin:0 0 12px 0;">ğŸ“ˆ å­¸ç¿’æˆæ•ˆè¿½è¹¤</h2>

  <div class="topbar">
    ğŸ‘¤ ç©å®¶ï¼š<span id="userName" class="who">---</span>
    <button onclick="goGame()">è¿”å›éŠæˆ²</button>
    <button onclick="logout()">ç™»å‡º</button>
  </div>

  <div class="row">
    <label>æ­Œæ›²</label>
    <select id="reportSongSelect" style="min-width:260px;" onchange="loadReport()"></select>

    <label>é–‹å§‹</label>
    <input id="fromDT" type="date" />

    <label>çµæŸ</label>
    <input id="toDT" type="date" />
  </div>

  <div style="margin-top:18px; background:#222; padding:12px; border-radius:10px;">
    <canvas id="reportChart" height="120"></canvas>
  </div>

  <p class="hint">å›ºå®šé¡¯ç¤ºã€Œæ¯æ¬¡ç´€éŒ„ï¼ˆåˆ°å°æ™‚ï¼‰ã€ï¼šç§’æ•¸è¶Šä½è¶Šå¥½ã€‚</p>
  <p id="reportMsg" style="color:#ffcc66; margin:0;"></p>
</div>

<script>
/* ===== å°å›éŠæˆ² ===== */
function goGame() {
  location.href = "index.html";
}

/* ===== ç™»å‡º ===== */
function logout() {
  localStorage.removeItem("userId");
  localStorage.removeItem("userName");
  location.href = "index.html";
}

/* ===== ç™»å…¥æª¢æŸ¥ ===== */
function ensureLogin() {
  const id = localStorage.getItem("userId");
  const name = localStorage.getItem("userName");
  if (!id || !name) {
    location.href = "index.html";
    return null;
  }
  document.getElementById("userName").innerText = `${id}ï½œ${name}`;
  return { id, name };
}

/* ===== æ­Œå–® ===== */
async function initReportSongList() {
  const sel = document.getElementById("reportSongSelect");
  sel.innerHTML = "";

  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "å…¨éƒ¨æ­Œæ›²";
  sel.appendChild(optAll);

  try {
    const res = await fetch("/test/api/get_songs.php", { cache: "no-store" });
    if (!res.ok) throw new Error(await res.text());
    const rows = await res.json();

    (rows || []).forEach(r => {
      const name = r.song_name || r.name || r.song || "";
      if (!name) return;
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    });
  } catch (e) {
    console.error(e);
  }
}

/* ===== åœ–è¡¨ ===== */
let progressChart = null;

function ymd(d){ return d.toISOString().slice(0,10); }

// date -> datetime (æ•´å¤©ç¯„åœ)
function toFromDT(dateStr){ return dateStr ? `${dateStr} 00:00:00` : ""; }
function toToDT(dateStr){ return dateStr ? `${dateStr} 23:59:59` : ""; }

// created_at å®¹éŒ¯æ­£è¦åŒ–
function normalizeDatetime(s){
  if(!s) return "";
  s = String(s).trim();
  s = s.replace(/\//g, "-");
  s = s.replace("T", " ");
  return s;
}

async function loadReport() {
  const msgEl = document.getElementById("reportMsg");
  msgEl.textContent = "";

  const user = ensureLogin();
  if (!user) return;

  const songName = document.getElementById("reportSongSelect").value || "";

  const fromDate = document.getElementById("fromDT").value || "";
  const toDate   = document.getElementById("toDT").value || "";

  // âœ… å›ºå®šï¼šæ¯æ¬¡ç´€éŒ„ï¼ˆåˆ°å°æ™‚ï¼‰
  const fromDT = toFromDT(fromDate);
  const toDT   = toToDT(toDate);

  const url = `/test/api/get_scores.php?player_id=${encodeURIComponent(user.id)}`
    + `&song_name=${encodeURIComponent(songName)}`
    + `&from=${encodeURIComponent(fromDT)}`
    + `&to=${encodeURIComponent(toDT)}`;

  let rows = [];
  try {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(await res.text());
    rows = await res.json();
    if (!Array.isArray(rows)) rows = [];
  } catch (e) {
    console.error(e);
    msgEl.textContent = "âŒ è®€å–æˆç¸¾å¤±æ•—ï¼ˆè«‹çœ‹ Console / Network Responseï¼‰";
    return;
  }

  const parsed = rows
    .map(r => ({
      seconds: Number(r.seconds ?? r.best_time ?? r.time ?? r.score),
      created_at: normalizeDatetime(r.created_at ?? r.play_date ?? r.date ?? "")
    }))
    .filter(x => !isNaN(x.seconds) && x.created_at);

  // âœ… æ¯æ¬¡ç´€éŒ„åˆ°å°æ™‚
  parsed.sort((a, b) => a.created_at.localeCompare(b.created_at));
  const labels = parsed.map(it => it.created_at.slice(0, 13)); // YYYY-MM-DD HH
  const data   = parsed.map(it => it.seconds);

  const canvas = document.getElementById("reportChart");
  if (progressChart) { progressChart.destroy(); progressChart = null; }

  if (labels.length === 0) {
    msgEl.textContent = "ç›®å‰æ²’æœ‰è³‡æ–™ï¼ˆå¯èª¿æ•´æ—¥æœŸç¯„åœæˆ–å…ˆç©ä¸€å±€ï¼‰";
    progressChart = new Chart(canvas, {
      type: "line",
      data: { labels: [], datasets: [{ label: "æ²’æœ‰è³‡æ–™", data: [] }] },
      options: { responsive: true }
    });
    return;
  }

  progressChart = new Chart(canvas, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "æ¯æ¬¡ç§’æ•¸ï¼ˆåˆ°å°æ™‚ï¼Œè¶Šä½è¶Šå¥½ï¼‰",
        data,
        borderWidth: 2,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { title: { display: true, text: "ç§’æ•¸" } },
        x: {
          title: { display: true, text: "æ—¥æœŸ(åˆ°å°æ™‚)" },
          ticks: { autoSkip: true, maxRotation: 0 }
        }
      }
    }
  });
}

/* ===== åˆå§‹åŒ– ===== */
window.addEventListener("load", async () => {
  const user = ensureLogin();
  if (!user) return;

  // é è¨­æœ€è¿‘ 7 å¤©
  const today = new Date();
  const d1 = new Date(today);
  d1.setDate(d1.getDate() - 7);
  document.getElementById("fromDT").value = ymd(d1);
  document.getElementById("toDT").value = ymd(today);

  await initReportSongList();

  document.getElementById("fromDT").addEventListener("change", loadReport);
  document.getElementById("toDT").addEventListener("change", loadReport);

  loadReport();
});
</script>

</body>
</html>
