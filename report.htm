<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å­¸ç¿’æˆæ•ˆè¿½è¹¤</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: 'Microsoft JhengHei', sans-serif; text-align:center; background:#222; color:white; padding-top:20px;}
    .box { border:1px solid #555; padding:20px; margin:15px auto; max-width:900px; border-radius:10px; background:#333; }
    button { padding:10px 18px; font-size:16px; cursor:pointer; border-radius:5px; border:none; margin:5px;}
    .btn-back { background:#555; color:#fff; }
    .row { display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; }
    input, select { padding:10px; font-size:16px; }
    .hint { margin-top:10px; color:#aaa; font-size:14px; }
  </style>
</head>

<body>

<div class="box">
  <h2>ğŸ“ˆ å­¸ç¿’æˆæ•ˆè¿½è¹¤</h2>
  <div style="margin-bottom:10px;">
    ğŸ‘¤ ç©å®¶ï¼š<span id="userName">---</span>
    <button class="btn-back" onclick="goGame()">è¿”å›éŠæˆ²</button>
    <button class="btn-back" onclick="logout()">ç™»å‡º</button>
  </div>

  <div class="row">
    <label>æ­Œæ›²</label>
    <select id="reportSongSelect" style="min-width:260px;" onchange="loadReport()"></select>

    <label>é–‹å§‹</label>
    <input id="fromDT" type="datetime-local" step="3600">

    <label>çµæŸ</label>
    <input id="toDT" type="datetime-local" step="3600">

    <label>æ¨¡å¼</label>
    <select id="reportMode" onchange="loadReport()">
      <option value="daily_best">æ¯å¤©æœ€ä½³(æœ€çŸ­)</option>
      <option value="each_try" selected>æ¯æ¬¡ç´€éŒ„(åˆ°å°æ™‚)</option>
      <option value="hour_best">æ¯å°æ™‚æœ€ä½³</option>
    </select>
  </div>

  <div style="margin-top:18px; background:#222; padding:12px; border-radius:10px;">
    <canvas id="reportChart" height="120"></canvas>
  </div>

  <p class="hint">è¶Šä½è¶Šå¥½ï¼šç§’æ•¸è¶ŠçŸ­ä»£è¡¨è¶Šç†Ÿç·´ã€‚</p>
  <p id="reportMsg" style="color:#ffcc66;"></p>
</div>

<script>
  // ===== å°å›éŠæˆ² =====
  function goGame() {
    location.href = "index.html";
  }

  // ===== ç™»å‡º =====
  function logout() {
    localStorage.removeItem("userId");
    localStorage.removeItem("userName");
    location.href = "index.html";
  }

  // ===== æª¢æŸ¥ç™»å…¥ =====
  function ensureLogin() {
    const id = localStorage.getItem("userId");
    const name = localStorage.getItem("userName");
    if (!id || !name) {
      location.href = "index.html";
      return null;
    }
    document.getElementById("userName").innerText = `${id}ï½œ${name}`;
    return { id, name };
  }

  // ===== å ±è¡¨ï¼šæ­Œå–® =====
  async function initReportSongList() {
    const sel = document.getElementById("reportSongSelect");
    sel.innerHTML = "";

    const optAll = document.createElement("option");
    optAll.value = "";
    optAll.textContent = "å…¨éƒ¨æ­Œæ›²";
    sel.appendChild(optAll);

    try {
      const res = await fetch("/test/api/get_songs.php", { cache:"no-store" });
      if (!res.ok) throw new Error(await res.text());
      const rows = await res.json();
      (rows || []).forEach(r => {
        const name = r.song_name || r.name || r.song || "";
        if (!name) return;
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
      });
    } catch (e) {
      console.error(e);
    }
  }

  // ===== å ±è¡¨ï¼šç•«åœ– =====
  let progressChart = null;

  async function loadReport() {
    const msgEl = document.getElementById("reportMsg");
    msgEl.textContent = "";

    const user = ensureLogin();
    if (!user) return;

    const songName = document.getElementById("reportSongSelect").value || "";
    const fromDT = document.getElementById("fromDT").value || "";
    const toDT   = document.getElementById("toDT").value || "";
    const mode   = document.getElementById("reportMode").value || "daily_best";

    const url = `/test/api/get_scores.php?player_id=${encodeURIComponent(user.id)}`
      + `&song_name=${encodeURIComponent(songName)}`
      + `&from=${encodeURIComponent(fromDT)}`
      + `&to=${encodeURIComponent(toDT)}`;

    let rows = [];
    try {
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error(await res.text());
      rows = await res.json();
      if (!Array.isArray(rows)) rows = [];
    } catch (e) {
      console.error(e);
      msgEl.textContent = "âŒ è®€å–æˆç¸¾å¤±æ•—ï¼ˆè«‹çœ‹ Console / Network Responseï¼‰";
      return;
    }

    const parsed = rows
      .map(r => ({
        seconds: Number(r.seconds ?? r.best_time ?? r.time ?? r.score),
        created_at: String(r.created_at ?? r.play_date ?? r.date ?? "")
      }))
      .filter(x => !isNaN(x.seconds) && x.created_at);

    let labels = [];
    let data = [];
    let xTitle = "æ—¥æœŸ";

    if (mode === "daily_best") {
      const bestByDate = new Map();
      for (const it of parsed) {
        const d = it.created_at.slice(0, 10); // YYYY-MM-DD
        const prev = bestByDate.get(d);
        if (prev == null || it.seconds < prev) bestByDate.set(d, it.seconds);
      }
      labels = Array.from(bestByDate.keys()).sort();
      data = labels.map(d => bestByDate.get(d));
      xTitle = "æ—¥æœŸ";

    } else if (mode === "each_try") {
      parsed.sort((a, b) => a.created_at.localeCompare(b.created_at));
      labels = parsed.map(it => it.created_at.slice(0, 13)); // YYYY-MM-DD HH
      data = parsed.map(it => it.seconds);
      xTitle = "æ—¥æœŸ(åˆ°å°æ™‚)";

    } else if (mode === "hour_best") {
      const bestByHour = new Map();
      for (const it of parsed) {
        const h = it.created_at.slice(0, 13);
        const prev = bestByHour.get(h);
        if (prev == null || it.seconds < prev) bestByHour.set(h, it.seconds);
      }
      labels = Array.from(bestByHour.keys()).sort();
      data = labels.map(h => bestByHour.get(h));
      xTitle = "æ—¥æœŸ(åˆ°å°æ™‚)";
    }

    const canvas = document.getElementById("reportChart");
    if (progressChart) { progressChart.destroy(); progressChart = null; }

    if (labels.length === 0) {
      msgEl.textContent = "ç›®å‰æ²’æœ‰è³‡æ–™ï¼ˆè«‹èª¿æ•´æ™‚é–“ç¯„åœæˆ–å…ˆç©ä¸€å±€å†çœ‹ï¼‰";
      progressChart = new Chart(canvas, {
        type: "line",
        data: { labels: [], datasets: [{ label: "æ²’æœ‰è³‡æ–™", data: [] }] },
        options: { responsive: true }
      });
      return;
    }

    progressChart = new Chart(canvas, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label:
            mode === "daily_best" ? "æ¯å¤©æœ€ä½³ç§’æ•¸ï¼ˆè¶Šä½è¶Šå¥½ï¼‰" :
            mode === "hour_best"  ? "æ¯å°æ™‚æœ€ä½³ç§’æ•¸ï¼ˆè¶Šä½è¶Šå¥½ï¼‰" :
                                    "æ¯æ¬¡ç§’æ•¸ï¼ˆè¶Šä½è¶Šå¥½ï¼‰",
          data,
          borderWidth: 2,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { title: { display: true, text: "ç§’æ•¸" } },
          x: {
            title: { display: true, text: xTitle },
            ticks: { autoSkip: true, maxRotation: 0 }
          }
        }
      }
    });
  }

  // ===== åˆå§‹åŒ– =====
  window.addEventListener("load", async () => {
    const user = ensureLogin();
    if (!user) return;

    await initReportSongList();
    document.getElementById("fromDT").addEventListener("change", loadReport);
    document.getElementById("toDT").addEventListener("change", loadReport);
    loadReport();
  });
</script>

</body>
</html>
